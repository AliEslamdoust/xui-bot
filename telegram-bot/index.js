const{Telegraf:_}=require('telegraf'),c=require('./lib/database_handler'),d=require('./lib/log_handler'),e=require('./lib/axios_instance'),f=require('fs'),g=require('jalali-moment'),h=require('js-yaml'),B=require('path'),j=B.join('/root/telegram-bot/db/config.yaml'),{v4:k}=require('uuid'),{keys:A}=Object;let l;function m(){try{l=h.load(f.readFileSync(j));d.log('yamlData was loaded successfully','INFO')}catch(C){d.log(C,'ERROR')}}m();var n=l.BOT_TOKEN;var o=new _(n);let p={};o.use(async (_a,_b)=>{try{let D=_a.from.id;!p[D]&&(p[D]={});p[D].inviter=_a.update.message?_a.update.message.text.split(' ').pop():'';let _B=await aD();!_B.has(D)&&_c();async function _c(){let _A=await aB(D);if(aC)if(_A.length>0){let E=Array();let aS=0;for(let aT of _A){aS++;E.push([{text:`⚜️ کانال ${aS}⚜️`,url:`t.me/${aT}`}])}E.push([{text:'✔️ تایید عضویت',callback_data:'checkJoinedChannels'}]);_a.sendMessage('❗️لطفا برای ادامه کار با ربات ابتدا عضو کانال(های) زیر شوید❗️',{reply_markup:{inline_keyboard:E}})}else return _b();else return _b()}}catch(aU){d.log(aU,'ERROR')}});o.start(aV=>{let aW=aV.from.id;p[aW]={};let _C=aV.from.first_name;let _d=aV.from.last_name||'';_C=_C.replaceAll('/','');_d=_d.replaceAll('/','');p[aW].inviter=aV.payload;q(aW,'main_menu','','',aV.from.username||'',`${_C}/${_d}`)});o.on('callback_query',aX=>{let aY=aX.chat.id;p[aY].textReciever='';q(aY,aX.update.callback_query.data,!0,aX.msgId)});async function q(aZ,bA,bB,_D,_e,F){try{let bC=p[aZ].inviter;let bD=new String();let bE=Array();let bF=await c.getFullRow({userid:[aZ,'']},'users');if(!bF.data){let bG=await c.getAllRows({},'users');let bH=bG.data.length+1;bC=='/start'&&(bC='');await c.insertFullRow({id:bH,userid:aZ,username:_e,fullname:F,inviter:bC,user_lvl:'0',balance:0,status:'',reason:'',test_sub:0},'users');q(aZ,bA,bB,_D);return}let _E=bF.data.user_lvl;let _f=bF.data;switch(bA) {case 'checkJoinedChannels':bD='✅ عضویت شما با موفقیت تایید شد';q(aZ,'main_menu',!1,0,_e,F);break;case 'main_menu':if(_E!=0){bD='💠 به منوی اصلی خوش آمدید\n\n⚜️ لطفا گزینه مورد نظر خود را انتخاب کنید';bE=[[{text:'👨‍💼 مدیریت ربات',callback_data:'management'}],[{text:'🛒 فروشگاه',callback_data:'shop'},{text:'📥 دریافت تست',callback_data:'test'}],[{text:'💳 تراکنش های من',callback_data:'userPayments_0_1'}],[{text:'💎 افزایش موجودی',callback_data:'addBalance'},{text:'👤 حساب کاربری',callback_data:'user_panel'}],[{text:'📱 کانفیگ های من',callback_data:'myConfigs_1'},{text:'🎁 هدیه',callback_data:'gifts'}],[{text:'📩 تیکت ها',callback_data:'supportTickets_1'}]];break}bD='💠 به منوی اصلی خوش آمدید\n\n📡 اتصال تا آخرین لحظه\n☎️ پشتیبانی تا روز آخر\n🌐 دارای چند سرور در مناطق مختلف جهان برای اتصال بهتر\n🔥 قیمت منصفانه در کنار کیفیت بالا\n\n⚜️ لطفا گزینه مورد نظر خود را انتخاب کنید';bE=[[{text:'❕ دریافت پنل فروش',callback_data:'getPanel'}],[{text:'🛒 فروشگاه',callback_data:'shop'},{text:'📥 دریافت تست',callback_data:'test'}],[{text:'💳 تراکنش های من',callback_data:'userPayments_0_1'}],[{text:'💎 افزایش موجودی',callback_data:'addBalance'},{text:'👤 حساب کاربری',callback_data:'user_panel'}],[{text:'📱 کانفیگ های من',callback_data:'myConfigs_1'},{text:'🎁 هدیه',callback_data:'gifts'}],[{text:'✉️ تیکت های من',callback_data:'support'}]];!l.configs.give_test&&bE[1].pop();(!l.configs.give_panel&&_E==0)&&bE.shift();break;case 'management':bD='🛠 پنل مدیریت ربات:';switch(_E) {case 1:bE=[[{text:'👥 مشاهده کاربران',callback_data:'getAllUsers_1'},{text:'🔙 بازگشت به منوی اصلی',callback_data:'main_menu'}],[{text:'✍️ پیام همگانی',callback_data:'sendNotice'}]];break;case 2:bE=[[{text:'👨‍💼 مشاهده مدیران',callback_data:'seeAdmins'},{text:'👥 مشاهده کاربران',callback_data:'getAllUsers_1'}],[{text:'✍️ پیام همگانی',callback_data:'sendNotice'}]];break;case 3:bE=[[{text:'👨‍💼 مشاهده مدیران',callback_data:'seeAdmins'},{text:'👥 مشاهده کاربران',callback_data:'getAllUsers_1'}],[{text:'🛒 ویرایش محصولات',callback_data:'editProducts'},{text:'📣 کانال های قفل شده',callback_data:'changeLockedChannels'}],[{text:'✍️ پیام همگانی',callback_data:'sendNotice'}]];break;case 4:bE=[[{text:'💎 فعال کردن پنل',callback_data:'givePanels'}],[{text:'👨‍💼 مشاهده مدیران',callback_data:'seeAdmins'},{text:'👥 مشاهده کاربران',callback_data:'getAllUsers_1'}],[{text:'🛒 ویرایش محصولات',callback_data:'editProducts'},{text:'📣 کانال های قفل شده',callback_data:'changeLockedChannels'}],[{text:'💳 دخل و خرج',callback_data:'totalBalance'},{text:'⚙️ دیگر تنظیمات',callback_data:'otherSettings'}],[{text:'☢️ ریستارت هسته x-ray',callback_data:'restartXray'}],[{text:'🔄 سرویس چک',callback_data:'serviceChecker'},{text:'✍️ پیام همگانی',callback_data:'sendNotice'}]];break}!l.configs.give_panel&&bE.shift();bE.push([{text:'🔙 بازگشت به منوی اصلی',callback_data:'main_menu'}]);break;case 'getPanel':bD='❗️ تا اطلاع ثانوی پنل فروش ارائه نمیگردد';bE.push([{text:'🔙 بازگشت به منوی اصلی',callback_data:'main_menu'}]);break;case 'shop':bD='🛍 سرویس مورد نظر خود را انتخاب کنید:';let bI=A(l.credentials);if(bI.length===1&&l.credentials[bI[0]].active){q(aZ,'shopItems_'+bI[0],bB,_D,_e,F);return}for(let bN of bI){let bO=l.credentials[bN];if(!l.credentials[bN].active)continue;bE.push([{text:bO.name,callback_data:`shopItems_${bN}`}])}bE.push([{text:'🔙 بازگشت به منوی اصلی',callback_data:'main_menu'}]);break;case 'test':let bJ=await c.getFullRow({userid:[aZ]},'users');if(bJ.data.test_sub==1){bD='❗️ شما قبلا یک سرور تستی دریافت کرده اید';bE.push([{text:'🔙 بازگشت به منوی اصلی',callback_data:'main_menu'}]);break}let bK=await c.getFullRow({type:['test']},'pricing');bK=bK.data;bD=`جهت دریافت سرویس تستی (${bK.traffic} گیگ ${bK.duration} روزه ${bK.ip_limit} کاربره) بر روی دکمه "✅ تایید و دریافت سرور تستی" کلیک کنید`;bE=[[{text:'✅ تایید و دریافت سرور تستی',callback_data:'confirmTestServer'}],[{text:'🔙 بازگشت به منوی اصلی',callback_data:'main_menu'}]];break;case 'confirmTestServer':let bL=await c.getFullRow({userid:[aZ]},'users');if(bL.data.test_sub==1){bD='❗️ شما قبلا یک سرور تستی دریافت کرده اید';bE.push([{text:'🔙 بازگشت به منوی اصلی',callback_data:'main_menu'}]);break}let bM=await c.getFullRow({type:['test']},'pricing');bM=bM.data;let _F=bM.location;let _g=aL(16,!0);let _h={id:'',email:'',limitIp:bM.ip_limit,totalGB:bM.traffic*1024**3,expiryTime:Date.now()+bM.duration*24*60*60*1000,enable:!0,tgId:'',subId:_g,inbound:''};let I=l.credentials[_F].inbounds;let J=aL(9,!0);for(let bP in A(I)){_h.email=J+'-'+bP;_h.inbound=parseInt(A(I)[bP]);_h.id=aK();let bQ=await e.addClient(_h,_F);if(!bQ.ok)break}await c.updateFullRow({userid:[aZ]},{test_sub:1},'users');await c.insertFullRow({owner_id:aZ,users_id:`${aZ}/`,subId:_g,name:'تست',status:'active',location:_F,reserve:'',sentNotice:0},'subscriptions');bD=`✅ کانفیگ شما با موفقیت ساخته شد
از بخش "📱 کانفیگ های من" میتوانید لینک آن را دریافت کنید`;bE=[[{text:'📱 مشاهده کانفیگ',callback_data:`configInfo_${_g}`}],[{text:'🔙 بازگشت به منوی اصلی',callback_data:'main_menu'}]];break;case 'addBalance':bD=`💠 جهت افزایش موجودی خود لطفا با پشتیبانی به آیدی زیر هماهنگ کنید:
        
@${l.supportId}`;bE.push([{text:'🔙 بازگشت به منوی اصلی',callback_data:'main_menu'}]);break;case 'gifts':bE.push([{text:'🎁 وارد کردن کد هدیه',callback_data:'enterGiftCode'}]);let K=await c.getAllRows({enable:[1], hidden:[0,'AND']},'gifts');for(let bR of K.data)bE.push([{text:bR.name,callback_data:'recieveGift_'+bR.code}]);bD='🎁 هدیه های قابل دریافت رو میتونید در لیست زیر مشاهده کنین\n\n❗️ اگر هدیه ای قابل مشاهده نیست ممکن است به این دلیل باشد که شما واجد شرایط دریافت آن نیستید';bE.push([{text:'🔙 بازگشت به منوی اصلی',callback_data:'main_menu'}]);break;case 'enterGiftCode':isNaN(p[aZ].gitCodeCooldown)&&(p[aZ].gitCodeCooldown=Date.now()-10000);if(Date.now()-p[aZ].gitCodeCooldown<10000){bD='❗️ هر 10 ثانیه فقط یکبار میتوانید کد جدید امتحان کنید';bE.push([{text:'🔙 بازگشت',callback_data:'gifts'}]);break}p[aZ].textReciever='enterGiftCode';bD='🎁 لطفا کد هدیه را وارد کنید (هر 10 ثانیه فقط یکبار میتوان کد جدید وارد کرد)';bE.push([{text:'🔙 بازگشت',callback_data:'gifts'}]);break;case 'user_panel':bD='👤 اطلاعات حساب کاربری شما:\n\n';let L=await c.getUserSubs(aZ);L=L.data.length;let M=await c.getAllRows({inviter:[aZ]},'users');bD+=`🔰 شناسه کاربری: \`${_f.userid}\`
💎 موجودی حساب: ${aF(_f.balance)} تومان
👥 تعداد زیر مجموعه ها: ${M.data.length}

☑️ تعداد کانفیگ ها: ${L}

✅ با هر خرید زیرمجموعه هایتان، 10 درصد از مبلغ خرید آنها به عنوان هدیه به موجودی شما اضافه میشود`;bE.push([{text:'🔙 بازگشت به منوی اصلی',callback_data:'main_menu'},{text:'👥 دریافت لینک دعوت',callback_data:'getInviteLink'}]);break;case 'getInviteLink':let N=`https://t.me/${l.botId}?start=${aZ}`;bD=`❕ افرادی که با لینک زیر وارد ربات شوند زیرمجموعه شما حساب میشوند

✅ با هر خرید زیرمجموعه هایتان، 10 درصد از مبلغ خرید آنها به عنوان هدیه به موجودی شما اضافه میشود

لینک شما:
\`${N}\``;bE.push([{text:'🔙 بازگشت',callback_data:'user_panel'}]);break;case 'addMyConfig':p[aZ].textReciever='enterManualConfig';bD='❔ لطفا لینک یا خود کانفیگ رو ارسال کنید تا داخل حساب کاربریتون اضافه بشه:\n\n⚜️ کانفیگ های داخل حساب کاربریتون رو میتونین به صورت پیشرفته مدیریت کنید ';bE.push([{text:'🔙 بازگشت',callback_data:'myConfigs_1'}]);break;case 'support':bD='👤 در این قسمت میتواند با پشتیبانی صحبت کنید\n❓ تیکت جدید باز کنید یا در تیکت های باز شده مشکل خود را به اشتراک بگذارید';bE=[[{text:'🟢 تیکت های باز',callback_data:'openTickets/1'},{text:'📧 تمامی تیکت ها',callback_data:'allTickets/1'}],[{text:'🖊 نوشتن تیکت جدید',callback_data:'newTicket'}],[{text:'🔙 بازگشت',callback_data:'main_menu'}]];break;case 'newTicket':p[aZ].textReciever='enterTicketSubject';bD='🔰 در حال نوشتن یک تیکت جدید میباشید\n\nلطفا موضوع این تیکت را وارد کنید:';bE.push([{text:'🔙 بازگشت',callback_data:'support'}]);break;case 'sendNotice':bD='❔ این پیام را برای چه کسانی میخواهید ارسال کنید؟';bE=[[{text:'👨‍💼 تمامی مدیران',callback_data:'sendNoticetoAdmins'}],[{text:'👥 تمامی کاربران',callback_data:'sendNoticetoAll'}],[{text:'🔙 بازگشت',callback_data:'management'}]];break;case 'sendNoticetoAdmins':p[aZ].textReciever='sendNotice';p[aZ].noticeReciever='admins';bD='❕ لطفا پیامی که برای همه مدیران میخواهید ارسال کنید را وارد کنید:';bE.push([{text:'🔙 بازگشت',callback_data:'sendNotice'}]);break;case 'sendNoticetoAll':p[aZ].textReciever='sendNotice';p[aZ].noticeReciever='everyone';bD='❕ لطفا پیامی که برای همه کاربران میخواهید ارسال کنید را وارد کنید:';bE.push([{text:'🔙 بازگشت',callback_data:'sendNotice'}]);break;case 'confirmSendNotice':await u(p[aZ].noticeReciever,p[aZ].fullMessage);bD='✅ پیام مورد نظر با موفقیت برای تمامی کاربران مورد نظر ارسال شد';bE.push([{text:'🔙 بازگشت به منوی اصلی',callback_data:'main_menu'}]);break;case 'confirmAddNewConfig':let O=p[aZ].newConfigTraffic;let P=p[aZ].newConfigDuration;P=P==0?0:Date.now()+P*30*24*60*60*1000;let Q=p[aZ].newConfigIP;let R=p[aZ].newConfigLocation;let S=p[aZ].targetUsersId;let _t=aL(9,!0);let U=aL(16,!0);let V=A(l.credentials[R].inbounds);let W={id:0,email:'',limitIp:Q,totalGB:O,expiryTime:P,enable:!0,tgId:'',subId:U,inbound:0};for(let bS in V){let bT={...W};bT.id=aK();bT.inbound=V[bS];bT.email=_t+'-'+bS;let bU=await e.addClient(bT,R);if(!bU.ok)break}let X=await e.getRandomWords(2,4);X=X.data;await c.insertFullRow({owner_id:S,users_id:`${S}/`,subId:U,name:X[0]+'-'+X[1],status:'active',location:R,reserve:'',sentNotice:0},'subscriptions');bD='✅ کانفیگ با موفقیت به کاربر مورد نظر اضافه شد';bE.push([{text:'🔚 بازگشت',callback_data:`userConfigs_${S}`}]);aE(S,0,'✅ یک کانفیگ جدید از طرف مدیر برای شما فعال شد',[[{text:'📱 مشاهده کانفیگ',callback_data:`configInfo_${U}`}]],!1);break;case 'serviceChecker':let Y=aO==0?'🔴 غیر فعال':'🟢 فعال';bD=`❗️ وضعیت سرویس چکر:

${Y}

❓ سرویس چکر: سرویسی که در هر ${aO/1000} ثانیه چک میکند و کانفیگ های به اتمام رسیده را به کاربران گزارش میدهد
کانفیگ هایی که 5 روز از اتمامشان گذشته باشد را حذف میکند
و همینطور اگر سرویسی رزرو شده باشد، سرویس رزرو رو برای کانفیگ اصلی فعال میکند

‼️ برای غیرفعال کردن سرویس عدد 0 را بفرستید
 برای فعالسازی یا تنظیم تایمر یک عدد بزرگتر از 0 بفرستید (به ثانیه محاسبه میشود)`;p[aZ].textReciever='getCheckerTimer';bE.push([{text:'🔙 بازگشت',callback_data:'management'}]);break;case 'restartXray':let Z=A(l.credentials);bD='❗️ هسته کدام سرور را میخواهید ریستارت کنید؟';for(let bV of Z)bE.push([{text:bV,callback_data:`restart_${bV}`}]);bE.push([{text:'🔙 بازگشت',callback_data:'management'}]);break;default:if(bA.includes('getAllUsers_')){let bW=parseInt(bA.split('_')[1]);let bX=await c.getAllRows({},'users');let bY=await c.getFullRow({userid:[aZ]},'users');bY=bY.data;!bW&&(bW=1);p[aZ].textReciever='seeUserStats';bD=`👥 لیست تمامی کاربران ربات\n\nصفحه ${bW}\n\n⁉️ برای راحتی بیشتر میتونید شناسه کاربری کاربر رو بفرستید تا حساب کاربریشون رو مشاهده کنین`;bX.data.sort((a,b)=>a.userid-b.userid);let bZ=20*(bW-1);while (bZ<20*bW&&bZ<bX.data.length) {let cC=bX.data[bZ];if(bY.user_lvl!=4&&bY.user_lvl<=cC.user_lvl&&aZ!=cC.userid){bZ++;continue}let cD=cC.fullname.split('/')[0];bZ%2==0?bE.push([{text:cC.userid+' - '+cD,callback_data:`seeUserStats_${cC.userid}`}]):bE[bE.length-1].push({text:cC.userid+' - '+cD,callback_data:`seeUserStats_${cC.userid}`});bZ++}let cA=Array();let cB=Array();if(bW!=1){let cE=bW-1;cA.push({text:'⤴️ اولین صفحه',callback_data:'getAllUsers_'+1});cB.push({text:'◀️ صفحه قبل',callback_data:`getAllUsers_${cE}`})}cB.push({text:'🔙 بازگشت',callback_data:'management'});let _G=Math.ceil(bX.data.length/20);if(bW!=_G){let cF=bW+1;cA.push({text:'⤴️ آخرین صفحه',callback_data:`getAllUsers_${_G}`});cB.push({text:'▶️ صفحه بعد',callback_data:`getAllUsers_${cF}`})}bE.push(cA);bE.push(cB)}else if(bA.includes('seeUserStats_')){let cG=bA.split('_')[1];let cH=await c.getFullRow({userid:[cG]},'users');bD='👤 اطلاعات کاربر:\n\n';let cI=cH.data;let cJ=await c.getUserSubs(cG);let cK=aF(cI.balance);bD+=`🔹 سطح کاربر: 

شناسه کاربری: \`${cI.userid}\`
نام کامل: ${cI.fullname.split('/').join(' ')}
نام کاربری: @${cI.username}
تعداد کانفیگ ها: ${cJ.data.length}
موجودی: ${cK}
وضعیت کاربر: `;bE.push([{text:'💳 تغییر موجودی کاربر',callback_data:`userBalance_${cG}`},{text:'⛓ کانفیگ های کاربر',callback_data:`userConfigs_${cG}`}]);bE.push([{text:'📨 تیکت های کاربر',callback_data:`userTickets_${cG}_1`},{text:'💳 تراکنش های کاربر',callback_data:`userPayments_${cG}_1`}]);cI.status=='banned'?(bD+=`❌ مسدود
دلیل مسدودی: ${cI.reason}`,bE.push([{text:'♻️ رفع مسدودی کاربر',callback_data:`banUser_clear_${cG}`}])):(bD+='✅ فعال',bE.push([{text:'🚫 مسدود کردن کاربر',callback_data:`banUser_banned_${cG}`}]));bE.push([{text:'🔙 بازگشت',callback_data:'getAllUsers_1'}])}else if(bA.includes('banUser_')){let cL=bA.split('_')[1];let cM=bA.split('_')[2];let cN=await c.getFullRow({userid:[cM,'']},'users');let cO=cN.data;bD=`⁉️ از مسدود سازی کاربر "${cO.fullname.split('/').join(' ')}" با شناسه کاربری (${cO.userid}) و نام کاربری "@${cO.username}" مطمئن هستید؟`;let cP=cL=='banned'?'✅ تایید و مسدود کردن':'✅ تایید و رفع مسدودی';bE.push([{text:cP,callback_data:`confirmBan_${cL}_${cM}`}],[{text:'🔙 بازگشت',callback_data:`seeUserStats_${cM}`}])}else if(bA.includes('confirmBan_')){let cQ=bA.split('_')[1];let cR=bA.split('_')[2];if(cQ=='banned'){p[aZ].banUser={userid:cR,status:cQ};bD='❓ لطفا دلیل رفع مسدودی این کاربر رو به صورت مختصر بنویسید:';p[aZ].textReciever='banUserReason'}else{let cS=await c.getFullRow({userid:[cR,'']},'users');if(cS.ok){let cT=cS.data;let cU=await c.updateFullRow({userid:[cR]},{status:cQ,reason:cT.reason},'users');cU.ok&&(bD=`✅وضعیت کاربر با موفقیت بروز شد
وضعیت جدید:
✅ آزاد`)}}bE.push([{text:'🔙 بازگشت',callback_data:`seeUserStats_${cR}`}])}else if(bA.includes('configInfo_')){let cV=bA.split('_')[1];let cW=await c.getFullRow({subId:[cV]},'subscriptions');cW=cW.data;let cX=await e.getConfigInfo(cV,cW.location);let cY=cX.data;let cZ=cY.totalGB/1024**3;let dA=cZ-(cY.up+cY.down)/1024**3;let dB=cW.name;let _H=cW.owner_id;let _i=cY.limitIp;let _j=cY.expiryTime;let _k=cW.status;let _l=cW.users_id;let _m='';let _n=!1;if(_k=='active'){let dC=cY.totalGB;let dD=cY.up;let dE=cY.down;let dF=cY.expiryTime;let dG=Date.now();!cY.enable||(dC!=0&&dD+dE>=dC)||(dF!=0&&dF<=dG)?_k='🔴 به اتمام رسیده':_k='🟢 فعال'}else{_k='🟡 متوقف شده توسط مدیر';_n=!0}let _o='';_l=_l.split('/');_l.pop();if(_H==aZ){_o+='💻 افراد زیر به کانفیگ شما دسترسی دارند:\n';for(let dH in _l){let dI=_l[dH];let dJ=++dH;dI==aZ?_o+=`${dJ}- شما`:_o+=`${dJ}- \`${dI}\``;_o+='\n'}_H='شما';bE=[[{text:'📥 دریافت کانفیگ',callback_data:`recieveMyConfig_${cV}`}]];if(!_n){p[aZ].previous=bA;bE[0].unshift({text:'♻️ تمدید',callback_data:`prolongConfig_${cV}`});(_j==0&&cZ==0)&&bE[0].shift()}bE.push([{text:'🔱 مدیریت کاربران',callback_data:`manageMyConfig_${cV}`}]);bE.push([{text:'❌ حذف',callback_data:`deleteMyConfig_${cV}`},{text:'⚙️ تنظیمات',callback_data:`setMyConfig_${cV}`}])}else{let dK=await c.getFullRow({userid:[_H]},'users');_H=dK.data.fullname.split('/').join(' ');bE.push([{text:'📥 دریافت کانفیگ',callback_data:`recieveMyConfig_${cV}`}])}dA=dA.toFixed(2)+'GB';cZ==0?(cZ='♾ نامحدود',_m=`⌛️ حجم مصرف شده: ${dA}`):(cZ=cZ.toFixed(2)+'GB',_m=`⌛️ حجم باقی مانده: ${dA}`);_i==0?_i='❌ بدون محدودیت':_i+=' کاربر';if(_j==0)_j='♾ نامحدود';else{let dL=new Date(_j);var H={timeZone:'Asia/Tehran',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:!1};let dM=dL.toLocaleString('en-US',H);_j=g(dL,'YYYY/M/D').locale('fa').format('YYYY/M/D')+' - '+dM}bD=`📱 مشخصات کانفیگ ${dB}:

⚪️ وضعیت کانفیگ: ${_k}

👤 صاحب کانفیگ: ${_H}
⏳ حجم کانفیگ: ${cZ}
👥 محدودیت کاربر همزمان: ${_i}

${_m}
📅 تاریخ انقضا: ${_j}

${_o}`;cW.status!='active'&&(bD=`‼️ این کانفیگ توسط مدیر متوقف شده است
            
            📱 مشخصات کانفیگ ${dB}:
          
          👤 صاحب کانفیگ: ${_H}
          ⏳ حجم کانفیگ: ${cZ}
          👥 محدودیت کاربر همزمان: ${_i}
          
          ${_m}
          📅 تاریخ انقضا: ${_j}`,bE=Array());bE.push([{text:'🔙 بازگشت',callback_data:'myConfigs_1'}])}else if(bA.includes('recieveMyConfig_')){let dN=bA.split('_')[1];let dO=await c.getFullRow({subId:[dN,'']},'subscriptions');let dP=await e.getConfigInfo(dN,dO.data.location);let dQ=dP.data;bD=`🔗 لینک کانفیگ شما:

${l.credentials[dO.data.location].sub_address+dQ.subId}

لینک بالا را کپی و در برنامه مورد نظر خود وارد کنید ✅
⁉️ جهت دریافت کانفیگ اصلی (بدون لینک) گزینه مربوطه را انتخاب کنید`;bE=[[{text:'🔑 دریافت دستی کانفیگ',callback_data:`getConfigCode_${dN}`}],[{text:'🔙 بازگشت',callback_data:`configInfo_${dN}`}]]}else if(bA.includes('getConfigCode_')){let dR=bA.split('_')[1];let dS=await c.getFullRow({subId:[dR,'']},'subscriptions');let dT=dS.data.location;let dU=await e.getConfigInfo(dR,dT);let dV=dU.data;let dW=dV.id;let dX=l.credentials[dT].inbounds;bD='🔰 کانفیگ های شما:\n\n';for(let dY in A(dX)){let dZ=dX[A(dX)[dY]];let eA={ps:dZ[1],add:l.credentials[dT].panel_address,port:dZ[0],id:dW[dY]};let eB;if(dZ[2]=='vmess')eB=aG(eA);else dZ[2]=='vless'&&(eB=aH(eA));bD+=`\`${eB}\`\n\n`}bD+='کانفیگ های بالا را کپی و در برنامه مورد نظر خود وارد کنید ✅';bE.push([{text:'🔙 بازگشت',callback_data:`configInfo_${dR}`}])}else if(bA.includes('deleteMyConfig_')){let eC=bA.split('_')[1];p[aZ].textReciever='confirmConfigDelete';let eD=await e.getRandomWords(1,6);eD=eD.data[0];p[aZ].randomPhrase=eD;p[aZ].subIdName=eC;bD=`⁉️ اگر از حذف کانفیگ اطمینان دارید لطفا کلمه رندوم زیر را بفرستید:

\`${eD}\`

🚫 این عمل به هیچ عنوان قابل بازگشت نیست و سرویس حذف شده به هیچ عنوان قابل بازیابی نیست

‼️ مسئولیت این کار 100% با شماست

جهت لغو روی دکمه برگشت کلیک کنید`;bB=!1;bE.push([{text:'🔙 بازگشت',callback_data:'myConfigs_1'}])}else if(bA.includes('manageMyConfig_')){let eE=bA.split('_')[1];let eF=await c.getFullRow({subId:[eE]},'subscriptions');let eG=eF.data.users_id.split('/');eG.pop();let eH='';for(let eI in eG){let eJ=eG[eI];if(eJ==aZ){eH+=`${++eI}- شما\n\n`;continue}let eK=await c.getFullRow({userid:[eJ]},'users');if(!eK.ok)continue;eH+=`${++eI}-\nشناسه کاربری:\n\`${eJ}\`\nنام کاربر:\n${eK.data.fullname.split('/')[0]}\n\n`}bD=`👥 افرادی که هم اکنون به کانفیگ "${eF.data.name}" دسترسی دارند:

${eH}`;bE=[[{text:'➕ افزودن کاربر',callback_data:`addConfigClient_${eE}`}],[{text:'➖ حذف کاربر',callback_data:`removeConfigClient_${eE}`}],[{text:'🔙 بازگشت',callback_data:`configInfo_${eE}`}]]}else if(bA.includes('addConfigClient_')){let eL=bA.split('_')[1];p[aZ].configName=eL;p[aZ].textReciever='addClientToConfig';bD='❕ شناسه کاربریِ کاربر مورد نظر را ارسال کنید (کاربر باید عضو ربات باشد):';bE.push([{text:'🔙 بازگشت',callback_data:`configInfo_${eL}`}]);bB=!1}else if(bA.includes('addedClientConfig_')){let eM=bA.split('_')[1];let eN=bA.split('_')[2];let eO=await c.getFullRow({subId:[eN]},'subscriptions');let eP=eO.data.users_id;if(eP.includes(eM)){bD='❕ این کاربر از قبل به این کانفیگ دسترسی دارد';break}let eQ=await c.getFullRow({userid:[eM]},'users');eP+=`${eM}/`;c.updateFullRow({subId:[eN]},{users_id:eP},'subscriptions');bD='✅ کاربر با موفقیت اضافه شد';bE.push([{text:'🔙 بازگشت',callback_data:`configInfo_${eN}`}])}else if(bA.includes('removeConfigClient_')){let eR=bA.split('_')[1];p[aZ].configName=eR;p[aZ].textReciever='removeClientFromConfig';bD='❕ شناسه کاربریِ کاربر مورد نظر را ارسال کنید:';bE.push([{text:'🔙 بازگشت',callback_data:`configInfo_${eR}`}])}else if(bA.includes('removedClientConfig_')){let eS=bA.split('_')[1];let eT=bA.split('_')[2];let eU=await c.getFullRow({subId:[eT]},'subscriptions');let eV=eU.data.users_id;eV=eV.replace(`${eS}/`,'');eV==''&&(eV=null);c.updateFullRow({subId:[eT]},{users_id:eV},'subscriptions');bD='✅ کاربر با موفقیت حذف شد';bE.push([{text:'🔙 بازگشت',callback_data:`configInfo_${eT}`}])}else if(bA.includes('setMyConfig_')){let eW=bA.split('_')[1];let eX=await c.getFullRow({subId:[eW]},'subscriptions');let eY=eX.data.name;let eZ=eX.data.location;bD=`🔧 تنظیمات کانفیگ ${eW}:

🔑 نام کانفیگ: ${eY}
🔗 لینک فعلی کانفیگ:
${l.credentials[eZ].sub_address+eW}

❗️ توجه: با تغییر لینک کانفیگ، کانفیگِ تمامی افرادی که به کانفیگ متصل هستن قطع خواهد شد و باید از ربات لینک جدید رو از قسمت "📥 دریافت کانفیگ" دریافت کنن
❕ این قابلیت مناسب حذف دسترسی کاربرانی هست که قبلا لینک کانفیگ رو داشتن`;bE=[[{text:'🖋 تغییر نام کانفیگ',callback_data:`renameMyConfig_${eW}`}],[{text:'🔗 تغییر لینک کانفیگ',callback_data:`resubMyConfig_${eW}`}],[{text:'🔙 بازگشت',callback_data:`configInfo_${eW}`}]]}else if(bA.includes('renameMyConfig_')){let fA=bA.split('_')[1];bD='🖋 لطفا نام جدید کانفیگ را وارد کنید:';bE.push([{text:'🔙 بازگشت',callback_data:`setMyConfig_${fA}`}]);p[aZ].textReciever='renameConfigName';p[aZ].configName=fA}else if(bA.includes('resubMyConfig_')){let fB=bA.split('_')[1];bD='⁉️ از تغییر لینک کانفیگ مطمئن هستید؟\n\n❗️ توجه: این عمل غیرقابل بازگشت می باشد';bE=[[{text:'✅ تایید و دریافت لینک جدید',callback_data:`resetConfigLink_${fB}`}],[{text:'🔙 بازگشت',callback_data:`setMyConfig_${fB}`}]]}else if(bA.includes('resetConfigLink_')){let fC=bA.split('_')[1];let fD=await c.getFullRow({subId:[fC]},'subscriptions');let fE=fD.data.location;let fF=await e.getConfigInfo(fC,fE);let fG=fF.data;if(fG.email.length==0)break;let fH=aL(16,!0);let fI=fG.id;let fJ=aL(9,!0);for(let fK in fI){let fL=parseInt(fG.inbound[fK]);let fM={...fG};fM.id=aK();fM.subId=fH;fM.inbound=fL;fM.email=fJ+'-'+fK;let fN=await e.addClient(fM,fE);if(!fN.ok)break;let fO=await e.removeClient({id:fI[fK], inbound:fL},fE);if(!fO.ok)break;fM.usage=fG.up+fG.down;let fP=await e.changeClientUsage(fM,fE);if(!fP.ok)break}await c.updateFullRow({subId:[fC]},{subId:fH},'subscriptions');let _I=await c.getFullRow({subId:[fC]},'reservations');_I.data&&await c.updateFullRow({subId:[fC]},{subId:fH},'reservations');bD=`✅ لینک با موفقیت بروز شد

لینک جدید:
${l.credentials[fE].sub_address+fH}`;bE.push([{text:'🔙 بازگشت',callback_data:`configInfo_${fH}`}])}else if(bA.includes('prolongConfig_')){let fQ=bA.split('_')[1];let fR=await c.getFullRow({subId:[fQ]},'subscriptions');let fS=await e.getConfigInfo(fQ,fR.data.location);fS=fS.data;let fT=fS.totalGB;let fU=fS.limitIp;let fV=fS.expiryTime;let fW=Date.now();bE.push([]);if(fV!=0&&fW<=fV){p[aZ].previous=bA;fT!=0&&bE[0].push({text:'🔋 افزایش ترافیک',callback_data:`moreTraffic_${fQ}`});fU!=0&&bE[0].push({text:'👥 افزایش کاربران',callback_data:`moreUsers_${fQ}`});bE.push([{text:'📱 رزرو سرویس',callback_data:`serviceProlong_${fQ}`}])}else{q(aZ,`serviceProlong_${fQ}`,bB,_D,_e,F);return}bD='⬆️ از بین گزینه های موجود انتخاب کنید:';bE.push([{text:'🔙 بازگشت',callback_data:`configInfo_${fQ}`}])}else if(bA.includes('serviceProlong_')){let fX=bA.split('_')[1];let fY=await c.getFullRow({subId:[fX]},'subscriptions');var G=fY.data.location;let fZ=await z(_F,'chooseProlongDuration',fX);bD=`📱 با رزرو هر یک از سرویس های زیر، بدون نیاز به دریافت لینک جدید به محض به پایان رسیدن سرویس فعلیتون، سرویس جدید براتون فعال میشه 

${fZ.info}

✅ سرویس های موجود:`;bE=fZ.buttons;if(fY.data.reserve!==''){let gA=fY.data.reserve.split('/');gA.pop();let gB=gA[gA.length-1];let gC=await c.getFullRow({reserve_id:[gB]},'reservations');if(gC.data.status=='pending'){let gD=gC.data;let gE=gD.traffic==0?'نامحدود ♾':gD.traffic+'GB';let gF=gD.duration==0?'نامحدود ♾':gD.duration+' ماهه';let gG=gD.ip==0?'نامحدود ♾':gD.ip+' کاربره';bD=`🟢 شما از قبل یک کانفیگ رزرو کرده اید

📱 مشخصات کانفیگ رزرو شده:

💾 حجم: ${gE}
📅 زمان: ${gF}
👥 محدودیت کاربر: ${gG}`;bE=Array()}}bE.push([{text:'🔙 بازگشت',callback_data:p[aZ].previous}])}else if(bA.includes('chooseProlongDuration_')){let gH=bA.split('_')[1];let gI=bA.split('_')[2];bD='❓ لطفا مدت زمان کانفیگ مورد نظر را انتخاب کنید:';bE=[[{text:'📅 یکماهه',callback_data:'prolongService_'+gH+'_1_'+gI}],[{text:'📅 دوماهه',callback_data:'prolongService_'+gH+'_2_'+gI}],[{text:'📅 سه ماهه',callback_data:'prolongService_'+gH+'_3_'+gI}]];let gJ=await c.getFullRow({item_id:[gH]},'pricing');l.credentials[gJ.data.location].give_unlimited_duartion&&bE.push([{text:'♾ زمان نامحدود',callback_data:'prolongService_'+gH+'_0_'+gI}]);bE.push([{text:'🔙 بازگشت',callback_data:`serviceProlong_${gI}`}]);p[aZ].previous=bA}else if(bA.includes('prolongService_')){let gK=bA.split('_')[1];let gL=bA.split('_')[2];let gM=bA.split('_')[3];let gN=await c.getFullRow({item_id:[gK]},'pricing');gN=gN.data;let gO=gN.traffic==0?'نامحدود ♾':gN.traffic+'GB';let gP=gL==0?'نامحدود ♾':`${gL} ماهه`;let gQ=gN.ip_limit==0?'نامحدود ♾':gN.ip_limit+' کاربره';let gR=await aA(gN.location,gL,gK);gR+=' تومان';let gS=await c.getFullRow({userid:[aZ]},'users');bA=bA.replace('prolongService_','prolongServiceConfirm_');bD=`⁉️ درحال خرید سرویس رزرو شده با مشخصات زیر میباشید:

💾 حجم: ${gO}
📅 زمان: ${gP}
👥 محدودیت کاربر: ${gQ}
💵 هزینه کانفیگ: ${aF(gR)}

💳 موجودی شما: ${aF(gS.data.balance)}

❗️ این سرویس به محض به پایان رسیدن سرویس فعلی شما فعال میشود

✅ در صورتی که این تراکنش مورد تایید شما میباشد، روی دکمه تایید کلیک کنید:`;bE=[[{text:'✅ تایید و پرداخت از موجودی',callback_data:bA}],[{text:'🔙 بازگشت',callback_data:`chooseProlongDuration_${gK}_${gM}`}]]}else if(bA.includes('prolongServiceConfirm_')){let gT=bA.split('_')[1];let gU=bA.split('_')[2];let gV=bA.split('_')[3];let gW=await c.getFullRow({item_id:gT},'pricing');gW=gW.data;let gX=await c.getFullRow({userid:[aZ]},'users');let gY=gW.price;let gZ=gW.ip_limit;let hA=gW.traffic;let hB=gW.location;let _J=aL(15,!0);await c.insertFullRow({userid:aZ, id:_J, price:gY, success:0, bought_item:'prolong_'+gT+'_'+gU, date:Date.now()},'payments');let _K=gX.data.balance;if(gY>_K){bD='❌ موجودی کافی نمی باشد';bE.push([{text:'🔙 بازگشت',callback_data:p[aZ].previous}]);break}let _L=aL(10,!0);await c.insertFullRow({reserve_id:_L,subId:gV,ip:gZ,traffic:hA,duration:gU,location:hB,status:'pending'},'reservations');await c.updateFullRow({subId:[gV]},{reserve:`${_L}/`,sentNotice:1},'subscriptions');let _M=await c.changeUserBalance(aZ,`-${gY}`);let _N=gX.data.inviter;if(_N!=''){await c.changeUserBalance(_N,gY);aE(_N,0,`🎁 به دلیل خرید زیرمجموعه شما، 10 درصد از مبلغ خرید آنها معادل ${gY} تومان به حساب شما اضافه شد`,[],!1)}await c.updateFullRow({id:[_J]},{success:_M.ok},'payments');bD=`✅ رزرو با موفقیت انجام شد
با اتمام بسته فعلی، بسته جدید فعال میشود✔️`;bE.push([{text:'🔙 بازگشت',callback_data:`configInfo_${gV}`}])}else if(bA.includes('moreTraffic_')){let hC=bA.split('_')[1];let hD=await c.getFullRow({subId:[hC]},'subscriptions');let hE=await e.getConfigInfo(hC,hD.data.location);hE=hE.data;let hF=((hE.totalGB-(hE.up+hE.down))/1024**3).toFixed(2);bB=!1;bD=`❓ مقداری ترافیکی که لازم دارید را وارد کنید

♾ حجم باقیمانده از سرویس فعلی: ${hF}GB

❗️ طریقه استفاده: اگر 10 گیگ حجم اضافه نیاز دارین عدد "10" را وارد کنید و مانند آن
‼️ عدد وارد شده باید از 1 بزرگتر و عدد طبیعی باشد`;p[aZ].textReciever='moreDataTraffic';p[aZ].configName=hC;bE.push([{text:'🔙 بازگشت',callback_data:`prolongConfig_${hC}`}])}else if(bA.includes('moreUsers_')){let hG=bA.split('_')[1];let hH=await c.getFullRow({subId:[hG]},'subscriptions');let hI=await e.getConfigInfo(hG,hH.data.location);bB=!1;p[aZ].textReciever='moreDataIP';p[aZ].configName=hG;bD=`👥 چه تعداد ظرفیت کاربر اضافه میخواهید؟

👤 ظرفیت کاربر فعلی: ${hI.data.limitIp}`;bE.push([{text:'🔙 بازگشت',callback_data:`prolongConfig_${hG}`}])}else if(bA.includes('confirmAddData_')){let hJ=bA.split('_')[1];let hK=bA.split('_')[2];let hL=parseInt(bA.split('_')[3]);let hM=parseInt(bA.split('_')[4]);let hN=await c.getFullRow({userid:[aZ]},'users');if(hN.data.balance<hM){bD='❌ موجودی کافی نمی باشد';bE.push([{text:'🔙 بازگشت',callback_data:`configInfo_${hK}`}]);break}let hO=await c.getFullRow({subId:[hK]},'subscriptions');let hP=hO.data.location;let hQ=aL(15,!0);await c.insertFullRow({userid:aZ, id:hQ, price:hM, success:0, bought_item:hJ, date:Date.now()},'payments');let hR=await e.getConfigInfo(hK,hP);hR=hR.data;hJ=='Traffic'?(hR.totalGB+=hL*1024**3,hR.enable=!0):(hR.limitIp+=hL);let hS=hR.id;let hT=l.credentials[hP].inbounds;let hU=hR.email;for(let hX in A(hT)){hR.email=hU[hX];hR.id=hS[hX];hR.inbound=parseInt(A(hT)[hX]);let hY=await e.updateClient(hR,hP);if(!hY.ok)break}let hV=await c.changeUserBalance(aZ,`-${hM}`);let hW=hN.data.inviter;if(hW!=''){await c.changeUserBalance(hW,hM);aE(hW,0,`🎁 به دلیل خرید زیرمجموعه شما، 10 درصد از مبلغ خرید آنها معادل ${hM} تومان به حساب شما اضافه شد`,[],!1)}await c.updateFullRow({id:[hQ]},{success:hV.ok},'payments');bD='✅ کانفیگ شما با موفقیت ارتقا یافت';bE.push([{text:'🔙 بازگشت',callback_data:`configInfo_${hK}`}])}else if(bA.includes('recieveGift_')){let hZ=bA.split('_')[1];let iA=await c.getFullRow({code:[hZ]},'gifts');if(iA.data.users_id.includes(aZ)){bD='❌ شما این هدیه را قبلا دریافت کرده اید';bE.push([{text:'🔙 بازگشت',callback_data:'gifts'}]);break}let iB=await c.useGift(aZ,hZ);switch(iB.code) {case 404:bD='❌ این جایزه دیگر قابل دسترسی نیست';break;case 401:bD=`❌ مهلت/محدودیت این جایزه به پایان رسیده است`;break;case 200:bD=`✅ ${iA.data.prize} تومان هدیه با موفقیت برای شما اضافه شد`;break}bE.push([{text:'🔙 بازگشت به منوی اصلی',callback_data:'main_menu'}])}else if(bA.includes('shopItems_')){let iC=bA.split('_')[1];let iD=await z(iC,'setDuration');bE=iD.buttons;bD=`${l.credentials[iC].name}\n\n🛍 سرویس مورد نظر خود را انتخاب کنید:\n`;bD+=iD.info;let iE=A(l.credentials).length===1?'main_menu':'shop';bE.push([{text:'🔙 بازگشت',callback_data:iE}])}else if(bA.includes('setDuration_')){let iF=bA.split('_')[1];bD='❓ لطفا مدت زمان کانفیگ مورد نظر را انتخاب کنید:';bE=[[{text:'📅 یکماهه',callback_data:`buyItem_${iF}_1`}],[{text:'📅 دوماهه',callback_data:`buyItem_${iF}_2`}],[{text:'📅 سه ماهه',callback_data:`buyItem_${iF}_3`}]];let iG=await c.getFullRow({item_id:[iF]},'pricing');let iH=iG.data.location;l.credentials[iH].give_unlimited_duartion&&bE.push([{text:'♾ زمان نامحدود',callback_data:`buyItem_${iF}_0`}]);bE.push([{text:'🔙 بازگشت',callback_data:`shopItems_${iH}`}])}else if(bA.includes('buyItem_')){let iI=bA.split('_')[1];let iJ=bA.split('_')[2];let iK=await c.getFullRow({item_id:[iI]},'pricing');iK=iK.data;let iL=iJ!=0?`${iJ} ماهه`:'نامحدود';let iM=iK.ip_limit!=0?iK.ip_limit+' کاربره':'نامحدود';let iN=iK.traffic!=0?iK.traffic+' گیگ':'نامحدود';let iO=iK.location;let iP=await aA(iO,iJ,iI);iP=aF(iP);bD=`❓ از خرید ${l.credentials[iO].name} با مشخصات زیر مطمئن هستید؟

👥 محدودیت کاربر: ${iM}
⏳ محدودیت زمان: ${iL}
🔋 محدودیت حجم: ${iN}

💎 قیمت: ${iP} تومان`;bE=[[{text:'✅ تایید و نهایی کردن خرید',callback_data:'confirmBuyItem_'+iI+'_'+iJ}],[{text:'🔙 بازگشت',callback_data:`setDuration_${iI}`}]]}else if(bA.includes('confirmBuyItem_')){let iQ=bA.split('_')[1];let iR=bA.split('_')[2];let iS=await c.getFullRow({item_id:[iQ]},'pricing');iS=iS.data;let iT=await aA(iS.location,iR,iQ);let iU=aL(15,!0);await c.insertFullRow({userid:aZ, id:iU, price:iT, success:0, bought_item:'newItem_'+iQ+'_'+iR, date:Date.now()},'payments');let iV=aF(iT);let iW=await c.getFullRow({userid:[aZ]},'users');if(iW.data.balance<iT){bD=`❌ موجودی شما کافی نمی باشد، برای خرید این سرویس به ${iV} تومان نیاز دارید`;bE.push([{text:'🔙 بازگشت به منوی اصلی',callback_data:'main_menu'}]);break}let iX=await c.changeUserBalance(aZ,`-${iT}`);let iY=iW.data.inviter;if(iY!=''){await c.changeUserBalance(iY,iT);aE(iY,0,`🎁 به دلیل خرید زیرمجموعه شما، 10 درصد از مبلغ خرید آنها معادل ${iT} تومان به حساب شما اضافه شد`,[],!1)}await c.updateFullRow({id:[iU]},{success:iX.ok},'payments');let iZ=await aM(iQ,iR,aZ);if(!iZ.ok){bD=`❗️ مشکلی رخ داد. لطفا از طریق تیکت این مشکل را گزارش دهید.
کد ارور:
\`xE500_${iQ}_${iR}\``;bE=[[{text:'👤 پشتیبانی',callback_data:'support'}],[{text:'🔙 بازگشت',callback_data:'main_menu'}]];break}bD=`✅ خرید با موفقیت انجام شد
جهت دریافت لینک کانفیگ به بخش "📱 کانفیگ های من" مراجعه کنید.`;bE=[[{text:'📱 کانفیگ های من',callback_data:'myConfigs_1'}],[{text:'🔙 بازگشت',callback_data:'main_menu'}]]}else if(bA.includes('openTicket_')){let jA=await r(bA.split('_')[1],aZ,bA.split('_')[2]);bD=jA.message.substring(0,4096);bE=jA.button}else if(bA.includes('seeAllMessages_')){let jB=bA.split('_')[1];let jC=bA.split('_')[2];bD=`❕ از دریافت تمامی پیام های ارسال/دریافت شده در تیکت شماره ${jB} مطمئن هستید؟`;bE=[[{text:'✅ تایید و دریافت همه پیام ها',callback_data:'confirmSeeAllMessages_'+jB+'_'+jC}],[{text:'🔙 بازگشت',callback_data:'openTicket_'+jB+'_'+jC}]]}else{if(bA.includes('confirmSeeAllMessages_')){let jD=await r(bA.split('_')[1],aZ,bA.split('_')[2],!0);let jE=jD.message;let jF=jE.length;let jG=Math.ceil(jF/4096);for(let jH=0;jH<jG;jH++){bD=jE.substring(jH*4096,(jH+1)*4096-3);jH>0&&(bD=`...${bD}`);jH==jG-1&&(bE=jD.button);await aE(aZ,0,bD,bE,!1)}return}if(bA.includes('closeTicket_')){let jI=bA.split('_')[1];bD=`❗️ از بستن تیکت شماره ${jI} مطمئن میباشید؟`;let jJ=bA.split('_')[2];if(jJ=='openTickets/1')jJ='openTicket_'+jI+'_'+jJ;else jJ=='allTickets/1'&&(jJ='openTicket_'+jI+'_'+jJ);bE=[[{text:'✅ تایید و بستن تیکت',callback_data:`confirmCloseTicket_${jI}`}],[{text:'🔙 بازگشت',callback_data:jJ}]]}else if(bA.includes('confirmCloseTicket_')){let jK=bA.split('_')[1];await c.updateFullRow({ticketId:[jK]},{status:'closed'},'tickets');bD='✅ تیکت با موفقیت بسته شد';bE.push([{text:'🔙 بازگشت',callback_data:'support'}])}else if(bA.includes('respondTicket_')){let jL=bA.split('_')[1];let jM=bA.split('_')[2];if(jM=='openTickets/1')jM='openTicket_'+jL+'_'+jM;else jM=='allTickets/1'&&(jM='openTicket_'+jL+'_'+jM);p[aZ].textReciever='userResponseTicket';p[aZ].ticketId=jL;p[aZ].previous=jM;bD='⁉️ لطفا پاسخ خود را ارسال کنید:';bE.push([{text:'🔙 بازگشت',callback_data:jM}])}else if(bA.includes('userBalance_')){let jN=bA.split('_')[1];bD='❓ لطفا یک گزینه را انتخاب کنید:';bE=[[{text:'➖ کاهش موجودی',callback_data:`changeTheBalance_decrease_${jN}`},{text:'➕ افزایش موجودی',callback_data:`changeTheBalance_increase_${jN}`}],[{text:'🔙 بازگشت',callback_data:`seeUserStats_${jN}`}]]}else if(bA.includes('changeTheBalance_')){let jO=bA.split('_')[1];let jP=bA.split('_')[2];p[aZ].textReciever='changeTheBalance';p[aZ].usersid=jP;p[aZ].balanceQuery=jO;jO=='decrease'?bD='❗️ لطفا مقدار موجودی که میخواهید از کاربر کم کنید را وارد کنید:':bD='❗️ لطفا مقدار موجودی که میخواهید به کاربر اضافه کنید را وارد کنید:';bE.push([{text:'🔙 بازگشت',callback_data:`userBalance_${jP}`}])}else if(bA.includes('userConfigs_')){let jQ=bA.split('_')[1];let jR=parseInt(bA.split('_')[2]);let jS=await c.getUserSubs(jQ);jS=jS.data;!jR&&(jR=1);let jT=20*(jR-1);while (jT<20*jR&&jT<jS.length) {let jW=jS[jT].subId;let jX=await c.getFullRow({subId:[jW]},'subscriptions');let jY=await e.getConfigInfo(jW,jX.data.location);if(!1){jT++;continue}let jZ=jY.data;let kA=jZ.totalGB;let kB=jZ.up+jZ.down;let kC=jZ.expiryTime;let kD=Date.now();let kE;switch(jX.data.status) {case 'active':!jZ.enable||(kA!=0&&kB>=kA)||(kC!=0&&kC<=kD)?kE='🔴 ':kE='🟢 ';break;default:kE='🟡 ';break}kE+=jX.data.name;let kF=`getUserConfigDetails_${jQ}_${jX.data.subId}`;let kG={text:kE,callback_data:kF};jT%2==0?bE.push([kG]):bE[bE.length-1].push(kG);jT++}let jU=Array();if(jR!=1){let kH=jR-1;jU.push({text:'◀️ صفحه قبل',callback_data:'userConfigs_'+jQ+'_'+kH})}jU.push({text:'🔙 بازگشت',callback_data:`seeUserStats_${jQ}`});let jV=Math.ceil(jS.length/20);if(jR!=jV){let kI=jR+1;jU.push({text:'▶️ صفحه بعد',callback_data:'userConfigs_'+jQ+'_'+kI})}jR==1&&bE.push([{text:'➕ افزودن کانفیگ جدید',callback_data:`addNewConfigForClient_${jQ}`}]);bE.push(jU);bD=`📱 کانفیگ های ${jQ}

صفحه ${jR}

        ⚜️لطفا از لیست کانفیگ ها یکی رو انتخاب کنید:
        
        ❔ راهنما:
        🟢 : سرویس فعال
        🟡 : سرویس توسط مدیر قطع شده
        🔴 : زمان/حجم سرویس تمام شده`}else if(bA.includes('getUserConfigDetails_')){let kJ=bA.split('_')[1];let kK=bA.split('_')[2];let kL=await c.getFullRow({subId:[kK]},'subscriptions');kL=kL.data;let kM=await e.getConfigInfo(kK,kL.location);let kN=kM.data;let kO=kN.totalGB/1024**3;let kP=kO-(kN.up+kN.down)/1024**3;let kQ=kL.name;let kR=kL.owner_id;let kS=kN.limitIp;let kT=kN.expiryTime;let kU=kL.status;let kV=kL.users_id;let kW='';let _O=!1;if(kU=='active'){let kX=kN.totalGB;let kY=kN.up;let kZ=kN.down;let lA=kN.expiryTime;let lB=Date.now();!kN.enable||(kX!=0&&kY+kZ>=kX)||(lA!=0&&lA<=lB)?kU='🔴 به اتمام رسیده':kU='🟢 فعال'}else kU='🟡 متوقف شده';let _p='';kV=kV.split('/');kV.pop();_p+='💻 افراد زیر به این کانفیگ دسترسی دارند:\n';for(let lC in kV){let lD=kV[lC];let lE=++lC;_p+=`${lE}- \`${lD}\``;_p+='\n'}kR=`\`${kR}\``;kP=kP.toFixed(2)+'GB';kO==0?(kO='♾ نامحدود',kW=`⌛️ حجم مصرف شده: ${kP}`):(kO=kO.toFixed(2)+'GB',kW=`⌛️ حجم باقی مانده: ${kP}`);kS==0?kS='❌ بدون محدودیت':kS+=' کاربر';if(kT==0)kT='♾ نامحدود';else{let lF=new Date(kT);let lG=lF.toLocaleString('en-US',{timeZone:'Asia/Tehran',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:!1});kT=g(lF,'YYYY/M/D').locale('fa').format('YYYY/M/D')+' - '+lG}bD=`📱 مشخصات کانفیگ ${kQ}:

⚪️ وضعیت کانفیگ: ${kU}

👤 صاحب کانفیگ: ${kR}
⏳ حجم کانفیگ: ${kO}
👥 محدودیت کاربر همزمان: ${kS}

${kW}
📅 تاریخ انقضا: ${kT}

${_p}`;let _q,_r;_O?(_q='❌ غیر فعالسازی کانفیگ',_r='disableUserConfig_'):(_q='✅ فعالسازی کانفیگ',_r='enableUserConfig_');bE=[[{text:_q,callback_data:_r+kJ+'_'+kK}],[{text:'📥 دریافت کانفیگ',callback_data:'recieveUsersConfig_'+kJ+'_'+kK},{text:'🔱 مدیریت کاربران',callback_data:'manageUsersConfig_'+kJ+'_'+kK}],[{text:'⏳ تغییر حجم کانفیگ',callback_data:'changeUserConfigs_'+kJ+'_'+kK+'_data'},{text:'⚠️ تغییر حجم استفاده شده',callback_data:'changeUserConfigs_'+kJ+'_'+kK+'_usage'}],[{text:'👥 تغییر محدودیت کاربر',callback_data:'changeUserConfigs_'+kJ+'_'+kK+'_IP'},{text:'📅 تغییر تاریخ انقضا',callback_data:'changeUserConfigs_'+kJ+'_'+kK+'_expiry'}],[{text:'❌ حذف',callback_data:'deleteUsersConfig_'+kJ+'_'+kK},{text:'🧑‍💻 تغییر صاحب کانفیگ',callback_data:'changeUserConfigs_'+kJ+'_'+kK+'_owner'}],[{text:'♻️ دریافت لینک جدید',callback_data:'changeUserConfigsSubId_'+kJ+'_'+kK}],[{text:'🔙 بازگشت',callback_data:`userConfigs_${kJ}`}]]}else if(bA.includes('disableUserConfig_')){let lH=bA.split('_')[1];let lI=bA.split('_')[2];bD='❗️ از غیرفعال کردن این کانفیگ مطمئن هستید؟';bE=[[{text:'✅ تایید و غیرفعال کردن',callback_data:'confirmDisableUserConfig_'+lH+'_'+lI}],[{text:'🔙 بازگشت',callback_data:'getUserConfigDetails_'+lH+'_'+lI}]]}else if(bA.includes('confirmDisableUserConfig_')){let lJ=bA.split('_')[1];let lK=bA.split('_')[2];let lL=await c.getFullRow({subId:[lK]},'subscriptions');lL=lL.data;let lM=await e.getConfigInfo(lK,lL.location);lM=lM.data;for(let lN in lM.id){let lO={...lM};lO.id=lM.id[lN];lO.email=lM.email[lN];lO.inbound=lM.inbound[lN];lO.enable=!1;await e.updateClient(lO,lL.location)}await c.updateFullRow({subId:[lK]},{status:'stopped'},'subscriptions');bD='✅ کانفیگ با موفقیت غیرفعال شد';bE.push([{text:'🔙 بازگشت',callback_data:'getUserConfigDetails_'+lJ+'_'+lK}])}else if(bA.includes('enableUserConfig_')){let lP=bA.split('_')[1];let lQ=bA.split('_')[2];bD='❗️ از فعال کردن این کانفیگ مطمئن هستید؟';bE=[[{text:'✅ تایید و فعال کردن',callback_data:'confirmEnableUserConfig_'+lP+'_'+lQ}],[{text:'🔙 بازگشت',callback_data:'getUserConfigDetails_'+lP+'_'+lQ}]]}else if(bA.includes('confirmEnableUserConfig_')){let lR=bA.split('_')[1];let lS=bA.split('_')[2];let lT=await c.getFullRow({subId:[lS]},'subscriptions');lT=lT.data;let lU=await e.getConfigInfo(lS,lT.location);lU=lU.data;for(let lV in lU.id){let lW={...lU};lW.id=lU.id[lV];lW.email=lU.email[lV];lW.inbound=lU.inbound[lV];lW.enable=!0;await e.updateClient(lW,lT.location)}await c.updateFullRow({subId:[lS]},{status:'active'},'subscriptions');bD='✅ کانفیگ با موفقیت فعال شد';bE.push([{text:'🔙 بازگشت',callback_data:'getUserConfigDetails_'+lR+'_'+lS}])}else if(bA.includes('recieveUsersConfig_')){let lX=bA.split('_')[1];let lY=bA.split('_')[2];let lZ=await c.getFullRow({subId:[lY]},'subscriptions');lZ=lZ.data;let mA=lZ.location;let mB=await e.getConfigInfo(lY,mA);mB=mB.data;let mC='';for(let mD in mB.id){let mE=mB.inbound[mD];let mF=l.credentials[mA].inbounds[mE];let mG={ps:mB.email[mD],add:l.credentials[mA].panel_address,port:mF[0],id:mB.id[mD]};let mH='';if(mF[2]=='vmess')mH=aG(mG);else mF[2]=='vless'&&(mH=aH(mG));mC+=`\`${mH}\n\n\``}bD=`🔗 لینک کانفیگ:
\`${l.credentials[mA].sub_address+lY}\`

🔑 کانفیگ دستی:
${mC}`;bE.push([{text:'🔙 بازگشت',callback_data:'getUserConfigDetails_'+lX+'_'+lY}])}else if(bA.includes('manageUsersConfig_')){let mI=bA.split('_')[1];let mJ=bA.split('_')[2];let mK=await c.getFullRow({subId:[mJ]},'subscriptions');mK=mK.data;let mL=mK.owner_id;let mM=mK.users_id.split('/');mM.pop();bD='👥 افراد زیر به این کانفیگ دسترسی دارند:\n\n';let mN=0;for(let mO of mM){mN++;bD+=`${mN}- \`${mO}\``;mO==mL&&(bD+=' - owner');bD+='\n'}bE=[[{text:'✖️ حذف کاربر',callback_data:'userConfigsUsers_'+mI+'_'+mJ+'_delete'},{text:'➕ افزودن کاربر',callback_data:'userConfigsUsers_'+mI+'_'+mJ+'_add'}],[{text:'🔙 بازگشت',callback_data:'getUserConfigDetails_'+mI+'_'+mJ}]]}else if(bA.includes('userConfigsUsers_')){let mP=bA.split('_')[1];let mQ=bA.split('_')[2];let mR=bA.split('_')[3];p[aZ].textReciever='userConfigsUser';p[aZ].userConfigsQuery=mR;p[aZ].usersid=mP;p[aZ].subId=mQ;bD='❔ لطفا شناسه شخص مورد نظر را ارسال کنید:';bE.push([{text:'🔙 بازگشت',callback_data:'getUserConfigDetails_'+mP+'_'+mQ}])}else if(bA.includes('changeUserConfigs_')){let mS=bA.split('_')[1];let mT=bA.split('_')[2];let mU=bA.split('_')[3];p[aZ].textReciever='changeUserConfigs';p[aZ].usersid=mS;p[aZ].subId=mT;p[aZ].changeQuery=mU;switch(mU) {case 'data':bD='❔ لطفا حجم جدید کانفیگ را وارد کنید (به گیگابایت محاسبه میشود):\n\n❕ برای حجم نامحدود لطفا عدد 0 را وارد کنید';break;case 'usage':bD='❔ لطفا حجم استفاده شده جدید کانفیگ را وارد کنید (به گیگابایت محاسبه میشود):';break;case 'IP':bD='❔ لطفا محدودیت کاربر جدید کانفیگ را وارد کنید \n\n❕ برای حذف محدودیت کاربر لطفا عدد 0 را وارد کنید';break;case 'expiry':bD='❔ لطفا تاریخ انقضای جدید کانفیگ را وارد کنید (به روز محسابه میشود): \n\n❕ برای حذف زمان انقضا لطفا عدد 0 را وارد کنید\n❕ به طور مثال برای تغییر تاریخ انقضا به یکماه آینده عدد 30 را وارد کنید';break;case 'owner':bD='❔ لطفا شناسه کاربری صاحب جدید کانفیگ را وارد کنید: \n\n❕ صاحب جدید باید یکی از کاربرانی باشد که به کانفیگ دسترسی دارند';break}bE.push([{text:'🔙 بازگشت',callback_data:'getUserConfigDetails_'+mS+'_'+mT}])}else if(bA.includes('changeUserConfigsSubId_')){let mV=bA.split('_')[1];let mW=bA.split('_')[2];bD='⁉️ از دریافت لینک جدید برای این کانفیگ مطمئن هستید؟ \n\n❗️ اتصال تمامی افرادی به این کانفیگ قطع خواهد شد و باید لینک خود را مجددا از داخل ربات دریافت کنند ';bE.push([{text:'✅ تایید و دریافت لینک جدید',callback_data:'confirmGetUserNewSubId_'+mV+'_'+mW}],[{text:'🔙 بازگشت',callback_data:'getUserConfigDetails_'+mV+'_'+mW}])}else if(bA.includes('confirmGetUserNewSubId_')){let mX=bA.split('_')[1];let mY=bA.split('_')[2];let mZ=await c.getFullRow({subId:[mY]},'subscriptions');mZ=mZ.data;let nA=mZ.location;let nB=await e.getConfigInfo(mY,nA);nB=nB.data;let nC=aL(16,!0);let nD=aL(9,!0);for(let nF in nB.id){let nG=parseInt(nB.inbound[nF]);let nH={...nB};nH.id=aK();nH.subId=nC;nH.inbound=nG;nH.email=nD+'-'+nF;let nI=await e.addClient(nH,nA);if(!nI.ok)break;let nJ=await e.removeClient({id:nB.id[nF], inbound:nG},nA);if(!nJ.ok)break;nH.usage=nB.up+nB.down;let nK=await e.changeClientUsage(nH,nA);if(!nK.ok)break}await c.updateFullRow({subId:[mY]},{subId:nC},'subscriptions');let nE=await c.getFullRow({subId:[mY]},'reservations');nE.data&&await c.updateFullRow({subId:[mY]},{subId:nC},'reservations');bD='✅ لینک کانفیگ با موفقیت بروز شد';bE.push([{text:'🔙 بازگشت',callback_data:'getUserConfigDetails_'+mX+'_'+nC}])}else if(bA.includes('deleteUsersConfig_')){let nL=bA.split('_')[1];let nM=bA.split('_')[2];let nN=await e.getRandomWords(1,6);nN=nN.data[0];p[aZ].textReciever='confirmDeleteUserConfig';p[aZ].randomString=nN;p[aZ].usersid=nL;p[aZ].subId=nM;bD=`⁉️ اگر از حذف این کانفیگ مطمئن هستید، لطفا کلمه زیر را ارسال کنید:
          
\`${nN}\``;bE.push([{text:'🔙 بازگشت',callback_data:'getUserConfigDetails_'+nL+'_'+nM}])}else if(bA.includes('respondUsersTicket_')){let nO=bA.split('_')[1];bE.push([{text:'🔙 بازگشت به منوی اصلی',callback_data:'main_menu'}]);let nP=await c.getFullRow({ticketId:[nO]},'tickets');nP=nP.data;if(nP.status=='closed'){bD='❌ این تیکت بسته شده و امکان پاسخگویی به آن نمی باشد';break}else nP.status=='support_response'?bD='⁉️ به این تیکت قبلا پاسخ داده شده\nاگر میخواهید پاسخ جدیدی برای آن ثبت کنید آن را بفرستید:':bD='❕ لطفا پاسخ خود را ارسال کنید:';p[aZ].textReciever='respondUsersTicket';p[aZ].ticketId=nO}else if(bA.includes('supportTickets_')){let nQ=parseInt(bA.split('_')[1]);let nR=await c.getAllRows({},'tickets');nR=nR.data;nR.sort((a,b)=>{if(a.status!==b.status){var statusOrder=['user_response','support_response','closed'];return (statusOrder.indexOf(a.status)-statusOrder.indexOf(b.status))}return b.last_response-a.last_response});!nQ&&(nQ=1);p[aZ].textReciever='getUserTicketById';bD=`📨 تمامی تیکت های ثبت شده در ربات رو میتوانید در این قسمت مشاهده کنید:

صفحه ${nQ}

⁉️ برای راحتی بیشتر میتونید شماره تیکت را ارسال کنید تا آن را مشاهده کنید
❔راهنما:

🟢: منتظر پاسخ پشتیبانی
🟡: منتظر پاسخ کاربر
🔴: تیکت بسته شده`;let nS=20*(nQ-1);while (nS<20*nQ&&nS<nR.length) {let nW=nR[nS];let nX=nW.ticketId;let nY=nW.status;let nZ;if(nY=='closed')nZ='🔴 ';else if(nY=='user_response')nZ='🟢 ';else nY=='support_response'&&(nZ='🟡 ');nZ+=nW.subject+' - '+nX;let oA=`seeUserTicket_${nX}`;let oB={text:nZ,callback_data:oA};nS%2==0?bE.push([oB]):bE[bE.length-1].push(oB);nS++}let nT=Array();let nU=Array();if(nQ!=1){let oC=nQ-1;nT.push({text:'⤴️ اولین صفحه',callback_data:'supportTickets_'+1});nU.push({text:'◀️ صفحه قبل',callback_data:`supportTickets_${oC}`})}nU.push({text:'🔙 بازگشت',callback_data:'main_menu'});let nV=Math.ceil(nR.length/20);if(nQ!=nV){let oD=nQ+1;nT.push({text:'⤴️ آخرین صفحه',callback_data:`supportTickets_${nV}`});nU.push({text:'▶️ صفحه بعد',callback_data:`supportTickets_${oD}`})}bE.push(nT);bE.push(nU)}else if(bA.includes('allTickets/')){let oE=parseInt(bA.split('/')[1]);let oF=await c.getAllRows({userid:[aZ]},'tickets');oF=oF.data;oF.sort((a,b)=>{if(a.status!==b.status){var statusOrder=['support_response','user_response','closed'];return (statusOrder.indexOf(a.status)-statusOrder.indexOf(b.status))}return b.last_response-a.last_response});!oE&&(oE=1);p[aZ].textReciever='getTicketById';p[aZ].previousPage='allTickets/1';bD=`📨 تمامی تیکت های ثبت شده تان در ربات رو میتوانید در این قسمت مشاهده کنید:

صفحه ${oE}

⁉️ برای راحتی بیشتر میتونید شماره تیکت را ارسال کنید تا آن را مشاهده کنید
❔راهنما:

🟢: منتظر پاسخ شما
🟡: منتظر پاسخ پشتیبانی
🔴: تیکت بسته شده`;let oG=20*(oE-1);while (oG<20*oE&&oG<oF.length) {let oK=oF[oG];let oL=oK.ticketId;let oM=oK.status;let oN;if(oM=='closed')oN='🔴 ';else if(oM=='support_response')oN='🟢 ';else oM=='user_response'&&(oN='🟡 ');oN+=oK.subject+' - '+oL;let oO=`openTicket_${oL}_allTickets/1`;let oP={text:oN,callback_data:oO};oG%2==0?bE.push([oP]):bE[bE.length-1].push(oP);oG++}let oH=Array();let oI=Array();if(oE!=1){let oQ=oE-1;oH.push({text:'⤴️ اولین صفحه',callback_data:'allTickets_'+1});oI.push({text:'◀️ صفحه قبل',callback_data:`allTickets_${oQ}`})}oI.push({text:'🔙 بازگشت',callback_data:'support'});let oJ=Math.ceil(oF.length/20);if(oE!=oJ){let oR=oE+1;oH.push({text:'⤴️ آخرین صفحه',callback_data:`allTickets_${oJ}`});oI.push({text:'▶️ صفحه بعد',callback_data:`allTickets_${oR}`})}bE.push(oH);bE.push(oI)}else if(bA.includes('openTickets/')){let oS=parseInt(bA.split('/')[1]);let oT=await c.getAllRows({userid:[aZ]},'tickets');oT=oT.data;let oU=Array();for(let oZ of oT)oZ.status!='closed'&&oU.push(oZ);oT=[...oU];oT.sort((a,b)=>{if(a.status!==b.status){var statusOrder=['support_response','user_response','closed'];return (statusOrder.indexOf(a.status)-statusOrder.indexOf(b.status))}return b.last_response-a.last_response});!oS&&(oS=1);p[aZ].textReciever='getTicketById';p[aZ].previousPage='openTickets/1';bD=`📨 تمامی تیکت های باز را میتوانید در این قسمت مشاهده کنید:

صفحه ${oS}

⁉️ برای راحتی بیشتر میتونید شماره تیکت را ارسال کنید تا آن را مشاهده کنید`;let oV=20*(oS-1);while (oV<20*oS&&oV<oT.length) {let pA=oT[oV];let pB=pA.ticketId;let pC=pA.status;let pD='';pD+=pA.subject+' - '+pB;let pE=`openTicket_${pB}_openTickets/1`;pC=='support_response'&&(pD+=' 🟢 +1');let pF={text:pD,callback_data:pE};oV%2==0?bE.push([pF]):bE[bE.length-1].push(pF);oV++}let oW=Array();let oX=Array();if(oS!=1){let pG=oS-1;oW.push({text:'⤴️ اولین صفحه',callback_data:'openTickets_'+1});oX.push({text:'◀️ صفحه قبل',callback_data:`openTickets_${pG}`})}oX.push({text:'🔙 بازگشت',callback_data:'support'});let oY=Math.ceil(oT.length/20);if(oS!=oY){let pH=oS+1;oW.push({text:'⤴️ آخرین صفحه',callback_data:`openTickets_${oY}`});oX.push({text:'▶️ صفحه بعد',callback_data:`openTickets_${pH}`})}bE.push(oW);bE.push(oX)}else if(bA.includes('seeUserTicket_')){let pI=bA.split('_')[1];let pJ=await s(pI);let pK=pJ.message;let pL=Math.ceil(pK.length/4096);for(let pM=0;pM<pL;pM++){bD=pK.substring(pM*4096,(pM+1)*4096-3);pM>0&&(bD=`...${bD}`);pM==pL-1&&(bE=pJ.button);await aE(aZ,0,bD,bE,!1)}if(bA.split('_')[2]=='watchingUser'){let pN=await c.getFullRow({ticketId:[pI]},'tickets');bE[bE.length-1][0].callback_data='userTickets_'+pN.data.userid+'_1'}}else if(bA.includes('closeUserTicket_')){let pO=bA.split('_')[1];bD=`❗️ آیا از بستن تیکت شماره ${pO} مطمئن هستید؟`;bE=[[{text:'✅ تایید و بستن تیکت',callback_data:`confirmCloseUserTicket_${pO}`}],[{text:'🔙 بازگشت',callback_data:`seeUserTicket_${pO}`}]]}else if(bA.includes('confirmCloseUserTicket_')){let pP=bA.split('_')[1];await c.updateFullRow({ticketId:[pP]},{status:'closed'},'tickets');bD=`✅ تیکت شماره ${pP} با موفقیت بسته شد`;bE.push([{text:'🔙 بازگشت',callback_data:`seeUserTicket_${pP}`}])}else if(bA.includes('myConfigs_')){let pQ=parseInt(bA.split('_')[1]);let pR=await c.getUserSubs(aZ);pR=pR.data;!pQ&&(pQ=1);let pS=20*(pQ-1);while (pS<20*pQ&&pS<pR.length) {let pV=pR[pS].subId;let pW=await c.getFullRow({subId:[pV]},'subscriptions');let pX=await e.getConfigInfo(pV,pW.data.location);if(!1){pS++;continue}let pY=pX.data;let pZ=pY.totalGB;let qA=pY.up+pY.down;let qB=pY.expiryTime;let qC=Date.now();let qD;switch(pW.data.status) {case 'active':!pY.enable||(pZ!=0&&qA>=pZ)||(qB!=0&&qB<=qC)?qD='🔴 ':qD='🟢 ';break;default:qD='🟡 ';break}qD+=pW.data.name;let qE=`configInfo_${pW.data.subId}`;let qF={text:qD,callback_data:qE};pS%2==0?bE.push([qF]):bE[bE.length-1].push(qF);pS++}let pT=Array();if(pQ!=1){let qG=pQ-1;pT.push({text:'◀️ صفحه قبل',callback_data:`myConfigs_${qG}`})}pT.push({text:'🔙 بازگشت',callback_data:'main_menu'});let pU=Math.ceil(pR.length/20);if(pQ!=pU){let qH=pQ+1;pT.push({text:'▶️ صفحه بعد',callback_data:`myConfigs_${qH}`})}pQ==1&&bE.push([{text:'💠 اضافه کردن دستی کانفیگ',callback_data:'addMyConfig'}]);bE.push(pT);bD=`📱 کانفیگ های شما

صفحه ${pQ}

        ⚜️لطفا از لیست کانفیگ هاتون یکی رو انتخاب کنید:
        
        ❔ راهنما:
        🟢 : سرویس فعال
        🟡 : سرویس توسط مدیر قطع شده
        🔴 : زمان/حجم سرویس تمام شده`}else if(bA.includes('addNewConfigForClient_')){let qI=bA.split('_')[1];let qJ=A(l.credentials);for(let qK of qJ){if(!l.credentials[qK].active)continue;bE.push([{text:l.credentials[qK].name,callback_data:'addNewConfigForUser_'+qI+'_'+qK}])}bD='❕ لطفا نوع سرویس مورد نظر را انتخاب کنید';bE.push([{text:'🔙 بازگشت',callback_data:`userConfigs_${qI}`}])}else if(bA.includes('addNewConfigForUser_')){let qL=bA.split('_')[1];let qM=bA.split('_')[2];p[aZ].textReciever='getNewConfigTraffic';p[aZ].targetUsersId=qL;p[aZ].newConfigLocation=qM;bD='❔ لطفا مقدار ترافیک مد نظر برای کانفیگ جدید را وارد کنید (به گیگابایت محاسبه میشود): \n\n❕ برای نامحدود 0 را وارد کنید';bE=[[{text:'🔙 مرحله قبل',callback_data:`addNewConfigForClient_${qL}`}],[{text:'🔚 لغو و بازگشت',callback_data:`userConfigs_${qL}`}]]}else if(bA.includes('userTickets_')){let qN=bA.split('_')[1];let qO=parseInt(bA.split('_')[2]);let qP=await c.getAllRows({userid:[qN]},'tickets');qP=qP.data;qP.sort((a,b)=>{if(a.status!==b.status){var statusOrder=['user_response','support_response','closed'];return (statusOrder.indexOf(a.status)-statusOrder.indexOf(b.status))}return b.last_response-a.last_response});!qO&&(qO=1);bD=`📨 تمامی تیکت های ${qN} را میتوانید در این قسمت مشاهده کنید:

صفحه ${qO}`;let qQ=20*(qO-1);while (qQ<20*qO&&qQ<qP.length) {let qU=qP[qQ];let qV=qU.ticketId;let qW=qU.status;let qX;if(qW=='closed')qX='🔴 ';else if(qW=='user_response')qX='🟢 ';else qW=='support_response'&&(qX='🟡 ');qX+=qU.subject+' - '+qV;let qY=`seeUserTicket_${qV}_watchingUser`;let qZ={text:qX,callback_data:qY};qQ%2==0?bE.push([qZ]):bE[bE.length-1].push(qZ);qQ++}let qR=Array();let qS=Array();if(qO!=1){let rA=qO-1;qR.push({text:'⤴️ اولین صفحه',callback_data:`userTickets_${qN}_${1}`});qS.push({text:'◀️ صفحه قبل',callback_data:`userTickets_${qN}_${rA}`})}qS.push({text:'🔙 بازگشت',callback_data:`seeUserStats_${qN}`});let qT=Math.ceil(qP.length/20);if(qO!=qT){let rB=qO+1;qR.push({text:'⤴️ آخرین صفحه',callback_data:`userTickets_${qN}_${qT}`});qS.push({text:'▶️ صفحه بعد',callback_data:`userTickets_${qN}_${rB}`})}bE.push(qR);bE.push(qS)}else if(bA.includes('userPayments_')){let rC=bA.split('_')[1];let rD=!1;rC==0&&(rC=aZ,rD=!0);let rE=parseInt(bA.split('_')[2]);let rF=await c.getAllRows({userid:[rC]},'payments');rF=rF.data;rF.sort((a,b)=>b.date-a.date);!rE&&(rE=1);let rG=rD?'شما':rC;bD=`💳 تمامی پرداخت های موفق و ناموفق ${rG} در این قسمت قابل مشاهده می باشد:

صفحه ${rE}`;let rH=20*(rE-1);while (rH<20*rE&&rH<rF.length) {let rM=rF[rH];let rN=rM.id;let rO=rM.success;let rP=rM.bought_item;let rQ=rO==1?'🟢 ':'🔴 ';if(rP.includes('newItem'))rQ+='سرویس جدید';else if(rP.includes('prolong'))rQ+='تمدید سرویس';else if(rP=='IP')rQ+='کاربر اضافه';else rP=='Traffic'&&(rQ+='ترافیک اضافه');let rR=rD?`seePayment_${rN}`:`seePayment_${rN}_watchingUser`;let rS={text:rQ,callback_data:rR};rH%2==0?bE.push([rS]):bE[bE.length-1].push(rS);rH++}let rI=Array();let rJ=Array();if(rE!=1){let rT=rE-1;rI.push({text:'⤴️ اولین صفحه',callback_data:`userPayments_${rC}_${1}`});rJ.push({text:'◀️ صفحه قبل',callback_data:`userPayments_${rC}_${rT}`})}let rK=rD?'main_menu':`seeUserStats_${rC}`;rJ.push({text:'🔙 بازگشت',callback_data:rK});let rL=Math.ceil(rF.length/20);if(rE!=rL){let rU=rE+1;rI.push({text:'⤴️ آخرین صفحه',callback_data:`userPayments_${rC}_${rL}`});rJ.push({text:'▶️ صفحه بعد',callback_data:`userPayments_${rC}_${rU}`})}bE.push(rI);bE.push(rJ)}else if(bA.includes('seePayment_')){let rV=bA.split('_')[1];let rW=bA.split('_')[2];let rX=await c.getFullRow({id:[rV]},'payments');rX=rX.data;let rY=rX.success?'🟢 موفق':'🔴 ناموفق';let rZ=rX.date;let sA=new Date(rZ);let sB=sA.toLocaleString('en-US',{timeZone:'Asia/Tehran',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:!1});rZ=g(sA,'YYYY/M/D').locale('fa').format('YYYY/M/D')+' - '+sB;let sC=rX.bought_item;if(sC.includes('newItem'))sC='سرویس جدید';else if(sC.includes('prolong'))sC='تمدید سرویس';else if(sC=='IP')sC='کاربر اضافه';else sC=='Traffic'&&(sC='ترافیک اضافه');bD=`❕ مشخصات تراکنش

🆔 کد تراکنش: \`${rX.id}\`
▫️ وضعیت تراکنش: ${rY}
💳 قیمت تراکنش: ${aF(rX.price)} تومان
🕐 تاریخ تراکنش: ${rZ}

📱 آیتم خریداری شده: ${sC}`;let sD=rW=='watchingUser'?'seeUserStats_'+rX.userid:'userPayments_0_1';bE.push([{text:'🔙 بازگشت',callback_data:sD}])}else if(bA.includes('restart_')){let sE=bA.split('_')[1];bD=`⁉️ از ریستارت کردن هسته x-ray در سرور ${sE} مطمئن هستید؟`;bE.push([{text:'✅ تایید و ریستارت',callback_data:`confirmRestart_${sE}`}]);bE.push([{text:'🔙 بازگشت',callback_data:'restart'}])}else if(bA.includes('confirmRestart_')){let sF=bA.split('_')[1];await e.restartXray(sF);bD=`✅ هسته x-ray در سرور ${sF} با موفقیت ریستارت شد`;bE.push([{text:'🔙 بازگشت',callback_data:'management'}])}}break}aE(aZ,_D,bD,bE,bB)}catch(sG){q(aZ,'main_menu',bB,_D,_e,F);d.log(sG,'WARN')}}async function r(sH,sI,sJ,sK){let sL=!1;let sM=await c.getFullRow({userid:[sI], ticketId:[sH,'AND']},'tickets');sM=sM.data;let sN='';let sO=sM.messages;sO=sO.split('%%');sO.pop();let sP=0;for(let sT=0;sT<=sO.length-1;sT++){if(sT<=sO.length-3&&!sK)continue;sP++;let sU=sO[sT].split('%')[0];let sV=sO[sT].split('%')[1];sU=='user'?sU='پیام شما':sU='پاسخ پشتیبانی';sV=sV.replaceAll('|درصد|','%');sN+=`${sP}- ${sU}:\n${sV}\n\n`}if(sK){let sW=[[{text:'🔙 بازگشت',callback_data:sJ}]];return{button:sW,message:sN}}let sQ;if(sM.status=='closed'){sQ='❌ این تیکت بسته شده';sL=!0}else sM.status=='user_response'?sQ='⏳ در انتظار پاسخ پشتیبانی':sQ='⏳ در انتظار پاسخ شما';let sR=`🔹 تیکت شماره ${sH}:
🔰 موضوع تیکت: ${sM.subject}

⭕️ وضعیت تیکت: ${sQ}

${sN}`;let sS=[[{text:'📚 مشاهده تمامی پیام ها',callback_data:'seeAllMessages_'+sH+'_'+sJ}]];!sL&&sS.push([{text:'❌ بستن تیکت',callback_data:'closeTicket_'+sH+'_'+sJ},{text:'💬 ارسال پاسخ',callback_data:'respondTicket_'+sH+'_'+sJ}]);sS.push([{text:'🔙 بازگشت',callback_data:sJ}]);return{button:sS,message:sR}}async function s(sX){let sY=!1;let sZ=await c.getFullRow({ticketId:[sX]},'tickets');sZ=sZ.data;let tA='';let tB=sZ.messages;tB=tB.split('%%');tB.pop();let tC=0;for(let tG=0;tG<=tB.length-1;tG++){tC++;let tH=tB[tG].split('%')[0];let tI=tB[tG].split('%')[1];tH=='user'?tH='پیام کاربر':tH='پاسخ پشتیبانی';tI=tI.replaceAll('|درصد|','%');tA+=`${tC}- ${tH}:\n${tI}\n\n`}let tD;if(sZ.status=='closed'){tD='❌ این تیکت بسته شده';sY=!0}else sZ.status=='user_response'?tD='⏳ در انتظار پاسخ پشتیبانی':tD='⏳ در انتظار پاسخ کاربر';let tE=`🔹 تیکت شماره ${sX}:
🔰 موضوع تیکت: ${sZ.subject}

⭕️ وضعیت تیکت: ${tD}

${tA}❗️دو پیام آخر در این تیکت فقط قابل مشاهده هستند
برای مشاهده تمامی پیام ها، پاسخ به این تیکت و یا بستن تیکت یکی از گزینه های زیر را انتخاب کنید:`;let tF=Array();!sY&&tF.push([{text:'❌ بستن تیکت',callback_data:`closeUserTicket_${sX}`},{text:'💬 ارسال پاسخ',callback_data:`respondUsersTicket_${sX}`}]);tF.push([{text:'🔙 بازگشت',callback_data:'supportTickets_1'}]);return{button:tF,message:tE}}o.on('text',async tJ=>{let tK=tJ.chat.id;let tL=tJ.message.text;let tM=Array();let tN;let tO=!1;let tP=!0;let tQ=!0;try{tL=x(tL);switch(p[tK].textReciever) {case 'banUserReason':let tV=tL+'/%/'+tK;let tW=await c.updateFullRow({userid:[p[tK].banUser.userid]},{status:p[tK].banUser.status,reason:tV},'users');tW.ok&&(tN=`✅وضعیت کاربر با موفقیت بروز شد
وضعیت جدید:
❌ مسدود`,tM.push([{text:'🔙 بازگشت',callback_data:`seeUserStats_${[p[tK].banUser.userid]}`}]));break;case 'confirmConfigDelete':let tX=p[tK].subIdName;if(tL!=p[tK].randomPhrase){tN='متن وارد شده با متن اصلی مطابقت ندارد ❌';tO=!0;break}let tY=await c.getFullRow({subId:[tX]},'subscriptions');var tR=await e.getConfigInfo(tX,tY.data.location);var tS=tR.data;for(let vQ in tR.data.email){var tT={id:tS.id[vQ],inbound:tS.inbound[vQ]};var tU=await e.removeClient(tT,tY.data.location);!tU.ok&&(tO=!0)}await c.updateFullRow({subId:[tX]},{users_id:''},'subscriptions');tN='✅ کانفیگ موردنظر با موفقیت حذف شد';break;case 'addClientToConfig':if(isNaN(tL)){tN=`❌ ورودی اشتباه میباشد. لطفا شناسه کاربری فرد مورد نظر را ارسال کنید:`;tM.push([{text:'🔙 بازگشت',callback_data:'configInfo_'+p[tK].configName}]);break}let tZ=await c.getFullRow({userid:[tL]},'users');if(!tZ.data){tN=`‼️ این کاربر هنوز در ربات عضو نشده
با لینک زیر میتونن ربات رو استارت کنن:

https://t.me/${l.botId}?start=${tK}`;tM.push([{text:'🔙 بازگشت',callback_data:'configInfo_'+p[tK].configName}]);break}let uA=tZ.data.fullname.split('/');tN=`👤 مشخصات کاربر انتخاب شده:

شناسه کاربری: ${tL}
نام:
${uA[0]} ${uA[1]}

⭕️ اگر مشخصات کاربر موردنظر با مشخصات بالا مطابقت دارد روی دکمه تایید کلیک کرده در غیر این صورت روی دکمه بازگشت کلیک کنید
‼️ با دادن دسترسی به کاربر، آنها میتوانند به کانفیگ شما متصل شوند. حذف/افزودن کاربر و یا حذف کانفیگ فقط به دست شما (صاحب کانفیگ) امکان پذیر است`;tM=[[{text:'✅ تایید و افزودن کاربر',callback_data:'addedClientConfig_'+tL+'_'+p[tK].configName}],[{text:'🔙 بازگشت',callback_data:'configInfo_'+p[tK].configName}]];break;case 'removeClientFromConfig':if(isNaN(tL)){tN=`❌ ورودی اشتباه میباشد. لطفا شناسه کاربری فرد مورد نظر را ارسال کنید:`;tM.push([{text:'🔙 بازگشت',callback_data:'configInfo_'+p[tK].configName}]);break}let uB=await c.getFullRow({userid:[tL]},'users');let uC=p[tK].configName;if(!uB.data){tN='❌ کاربر مورد نظر یافت نشد';tO=!0;break}let uD=await c.getFullRow({subId:[uC]},'subscriptions');if(!uD.data.users_id.includes(tL)){tN='❗️ این کاربر به سرویس شما دسترسی ندارد.';tO=!0;break}let uE=uB.data.fullname.split('/');tN=`👤 مشخصات کاربر انتخاب شده:

شناسه کاربری: ${tL}
نام:
${uE[0]} ${uE[1]}

⭕️ اگر مشخصات کاربر موردنظر با مشخصات بالا مطابقت دارد روی دکمه تایید کلیک کرده در غیر این صورت روی دکمه بازگشت کلیک کنید
‼️ با حذف دسترسی کاربر، آنها میتوانند به کانفیگ شما متصل شوند اما زمان و حجم باقیمانده را نمیتوانند مشاهده کنند. در صورتی که میخواهید دسترسی آنها را به طور کامل به سرور قطع کنید، لطفا برای این کانفیگ درخواست لینک مجدد نمایید`;tM=[[{text:'❌ تایید و حذف کاربر',callback_data:'removedClientConfig_'+tL+'_'+uC}],[{text:'🔙 بازگشت',callback_data:`configInfo_${uC}`}]];break;case 'renameConfigName':let uF=p[tK].configName;c.updateFullRow({subId:[uF]},{name:tL},'subscriptions');tN='✅ نام کانفیگ با موفقیت آپدیت شد';tM.push([{text:'🔙 بازگشت',callback_data:`setMyConfig_${uF}`}]);break;case 'moreDataTraffic':if(isNaN(tL)||tL<1){tN='❗️ورودی صحیح نمی باشد. لطفا یک عدد طبیعی وارد کنید ';tO=!0;break}let uG=await c.getFullRow({subId:[p[tK].configName]},'subscriptions');tL=~~tL;let uH=await e.getConfigInfo(p[tK].configName,uG.data.location);uH=~~uH.data.totalGB/1024**3+tL;let uI=await y(uG.data.location);uI=uI.traffic;let uJ=uI.find(t=>uH>=t.min&&uH<=t.max);uJ=uJ.price*tL;let _P=await c.getFullRow({userid:[tK]},'users');tN=`❓ مقدار ترافیک مورد نیاز شما:
  ${tL}GB
  
  💳 هزینه این مقدار ترافیک برابر است با: ${uJ} تومان و از موجودی فعلی شما کم میشود
  💰 موجودی فعلی شما: ${_P.data.balance} تومان
  
  💠 اگر این تراکنش مورد تایید شما میباشد روی دکمه تایید کلیک کنید:`;tM=[[{text:'✅ تایید و پرداخت',callback_data:'confirmAddData_Traffic_'+p[tK].configName+'_'+tL+'_'+uJ}],[{text:'🔙 بازگشت',callback_data:'prolongConfig_'+p[tK].configName}]];break;case 'moreDataIP':if(isNaN(tL)||tL<1){tN='❗️ورودی صحیح نمی باشد. لطفا یک عدد طبیعی وارد کنید ';tO=!0;break}let _Q=await c.getFullRow({subId:[p[tK].configName]},'subscriptions');tL=~~tL;let _R=await y(_Q.data.location);let _s=_R.addon[0].user*tL;let _T=await c.getFullRow({userid:[tK]},'users');tN=`❓ تعداد کاربرهای مورد نیاز شما:
    ${tL}
    
    💳 هزینه این تعداد کاربر اضافه برابر است با: ${_s} تومان و از موجودی فعلی شما کم میشود
    💰 موجودی فعلی شما: ${_T.data.balance} تومان
    
    💠 اگر این تراکنش مورد تایید شما میباشد روی دکمه تایید کلیک کنید:`;tM=[[{text:'✅ تایید و پرداخت',callback_data:'confirmAddData_IP_'+p[tK].configName+'_'+tL+'_'+_s}],[{text:'🔙 بازگشت',callback_data:'prolongConfig_'+p[tK].configName}]];break;case 'enterGiftCode':p[tK].gitCodeCooldown=Date.now();let _u=await c.getFullRow({code:[tL]},'gifts');if(!_u.data){tN='❌ کد وارد شده صحیح نمی باشد';tM.push([{text:'🔙 بازگشت',callback_data:'gifts'}]);break}if(_u.data.users_id.includes(tK)){tN='❌ شما این هدیه را قبلا دریافت کرده اید';tM.push([{text:'🔙 بازگشت',callback_data:'gifts'}]);break}_u.data.users_id+=`${tK}/`;let _v=await c.useGift(tK,tL);switch(_v.code) {case 404:tN='❌ این جایزه دیگر قابل دسترسی نیست';break;case 401:tN=`❌ مهلت/محدودیت این جایزه به پایان رسیده است`;break;case 200:tN=`✅ ${getGiftDetails.data.prize} تومان هدیه با موفقیت برای شما اضافه شد`;break}tM.push([{text:'🔙 بازگشت به منوی اصلی',callback_data:'main_menu'}]);break;case 'enterManualConfig':let _w,_x;let _y=!0;tM.push([{text:'🔙 بازگشت',callback_data:'myConfigs_1'}]);if(tL.includes('vmess://')){let vR=aI(tL.replace('vmess://',''));let vS=A(l.credentials);for(let vT of vS){if(_w)continue;try{let vU=await T(vR,vT);vU?(_w=vU,_x=vT,_y=!0):(_y=!1)}catch(vV){continue}}}else if(tL.includes('vless://')){let vW=aJ(tL.replace('vless://',''));let vX=A(l.credentials);for(let vY of vX){if(_w)continue;try{let vZ=await T(vW,vY);vZ?(_w=vZ,_x=vY,_y=!0):(_y=!1)}catch(wA){continue}}}else{let wB=A(l.credentials);for(let wC of wB){let wD=l.credentials[wC].sub_address;tL.includes(wD)&&(_y=!0,_x=wC,_w=tL.replace(wD,''))}}let _z=await e.getConfigInfo(_w,_x);(!_z.data||!1)&&(_y=!1);if(!_y){tN='❗️ کانفیگ وارد شده نامعتبر است';break}let uK=await c.getFullRow({subId:[_w]},'subscriptions');if(uK.data){tN='❌ این کانفیگ از قبل در ربات ثبت شده است';break}let uL=await e.getRandomWords(2,4);uL=uL.data;await c.insertFullRow({owner_id:tK,users_id:`${tK}/`,subId:_w,name:uL[0]+'-'+uL[1],status:'active',location:_x,reserve:'',sentNotice:0},'subscriptions');tN='✅ کانفیگ با موفقیت به حساب کاربری شما اضافه شد';break;case 'enterTicketSubject':p[tK].subject=tL;tN='📝 و حالا میتوانید پیام خود را به پشتیبانی ارسال کنید\n\n📎 مشکل خود را به طور کامل و در یک پیام بنویسید:';tM.push([{text:'🔙 بازگشت',callback_data:'support'}]);p[tK].textReciever='enterTicketBody';tQ=!1;break;case 'enterTicketBody':let uM=aL(6,!0,!1);await c.insertFullRow({ticketId:uM,userid:tK,subject:p[tK].subject,messages:'',status:'user_response'},'tickets');await v(tL,uM,'user');tN='✅ تیکت شما با موفقیت ایجاد شد';tM.push([{text:'🔙 بازگشت',callback_data:'support'}]);break;case 'userResponseTicket':await v(tL,p[tK].ticketId,'user');tN='✔️ پاسخ با موفقیت ثبت شد';tM.push([{text:'🔙 بازگشت',callback_data:p[tK].previous}]);break;case 'changeTheBalance':tL=parseInt(tL);let uN=p[tK].usersid;tM.push([{text:'🔙 بازگشت',callback_data:`seeUserStats_${uN}`}]);let uO=p[tK].balanceQuery;if(isNaN(tL)||tL<=0){tN='❗️ مقدار وارد شده باید یک عدد و از 0 بزرگتر باشد';break}let uP,uQ;uO=='increase'?(uP=tL,uQ=`✅ به موجودی شما ${tL} تومان از طرف مدیر اضافه شد`):(uP=`-${tL}`,uQ=`❗️ از طرف مدیر ${tL} تومان از موجودی شما کم شد`);await c.changeUserBalance(uN,uP);aE(uN,0,uQ,[],!1);tN='✅ موجودی کاربر با موفقیت تغییر کرد';break;case 'userConfigsUser':let uR=p[tK].userConfigsQuery;let uS=p[tK].usersid;let uT=p[tK].subId;tM.push([{text:'🔙 بازگشت',callback_data:'manageUsersConfig_'+uS+'_'+uT}]);let uU=await c.getFullRow({userid:[tL]},'users');uU=uU.data;if(!uU){tN='❌ شناسه کاربری اشتباه است یا کاربر مورد نظر در ربات عضو نشده';break}let uV=await c.getFullRow({subId:[uT]},'subscriptions');uV=uV.data;let uW=uR=='delete'?uV.users_id.replace(`${tL}/`,''):uV.users_id+tL+'/';await c.updateFullRow({subId:[uT]},{users_id:uW},'subscriptions');if(uR=='delete'){if(!uV.users_id.includes(tL)){tN='❌ کاربر مورد نظر به این کانفیگ دسترسی ندارد';break}tN='✅ کاربر مورد نظر با موفقیت حذف شد'}else uR=='add'&&(tN='✅ کاربر مورد نظر با موفقیت اضافه شد');break;case 'changeUserConfigs':tL=parseInt(tL);let uX=p[tK].subId;let uY=p[tK].usersid;tM.push([{text:'🔙 بازگشت',callback_data:'getUserConfigDetails_'+uY+'_'+uX}]);let uZ=await c.getFullRow({subId:[uX]},'subscriptions');uZ=uZ.data;let vA=await e.getConfigInfo(uX,uZ.location);vA=vA.data;if(isNaN(tL)){tN='❌ نوع ورودی صحیح نمی باشد';break}if(tL<0){tN='❌ لطفا یک عدد بزرگتر یا مساوی از 0 وارد کنید';break}let vB=!1;let vC=!1;let vD=!1;switch(p[tK].changeQuery) {case 'data':vA.totalGB=tL*1024**3;vB=!0;break;case 'usage':vA.usage=tL*1024**3;vC=!0;break;case 'IP':vA.limitIp=~~tL;vB=!0;break;case 'expiry':vA.expiryTime=Date.now()+tL*24*60*60*1000;vB=!0;break;case 'owner':let wE=await c.getFullRow({userid:[uY]},'users');if(!wE.data){tN='❌ شناسه کاربری اشتباه است یا کاربر مورد نظر در ربات عضو نشده';vD=!0;break}else if(!uZ.users_id.includes(tL)){tN='❌ کاربر به این کانفیگ دسترسی ندارد';vD=!0;break}await c.updateFullRow({subId:[uX]},{owner_id:tL},'subscriptions');break}if(vD)break;if(vB)for(let wF in vA.id){let wG={...vA};wG.id=vA.id[wF];wG.email=vA.email[wF];wG.inbound=vA.inbound[wF];await e.updateClient(wG,uZ.location)}else vC&&await e.changeClientUsage(vA,uZ.location);tN='✅ تغییرات با موفقیت اعمال شد';break;case 'confirmDeleteUserConfig':let vE=p[tK].usersid;let vF=p[tK].subId;console.log(vF);if(tL!==p[tK].randomString){tN='❌ متن وارد شده با متن اصلی مطابقت ندارد';tM.push([{text:'🔙 بازگشت',callback_data:'getUserConfigDetails_'+uN+'_'+subId}]);break}let vG=await c.getFullRow({subId:[vF]},'subscriptions');vG=vG.data;let vH=await e.getConfigInfo(vF,vG.location);vH=vH.data;for(let wH in vH.id){let wI=await e.removeClient({id:vH.id[wH], inbound:vH.inbound[wH]},vG.location);if(!wI.ok)break}await c.updateFullRow({subId:[vF]},{users_id:''},'subscriptions');tN='✅ کانفیگ با موفقیت حذف شد';tM.push([{text:'🔙 بازگشت',callback_data:`userConfigs_${vE}`}]);break;case 'respondUsersTicket':let vI=await c.getFullRow({ticketId:[p[tK].ticketId]},'tickets');await v(tL,vI.data.ticketId,vI.data.userid);tN='✅ پاسخ شما با موفقیت ثبت شد';tM=[[{text:'📨 مشاهده تیکت ها',callback_data:'supportTickets_1'}],[{text:'🔙 بازگشت به منوی اصلی',callback_data:'main_menu'}]];break;case 'seeUserStats':let vJ=await c.getFullRow({userid:[tL]},'users');if(!vJ.data){tN='❌ شناسه کاربری اشتباه است یا کاربر هنوز عضو ربات نشده';tM.push([{text:'🔙 بازگشت',callback_data:'getAllUsers_1'}]);break}q(tK,`seeUserStats_${tL}`,!1);return;case 'getUserTicketById':let vK=await c.getFullRow({ticketId:[tL]},'tickets');if(!vK.data){tN='❌  شماره تیکت وارد شده صحیح نمی باشد';tM.push([{text:'🔙 بازگشت',callback_data:'supportTickets_1'}]);break}q(tK,`seeUserTicket_${tL}`,!1);return;case 'getTicketById':let vL=await c.getFullRow({ticketId:[tL], userid:[tK,'AND']},'tickets');let vM=p[tK].previousPage;if(!vL.data){tN='❌  شماره تیکت وارد شده صحیح نمی باشد';tM.push([{text:'🔙 بازگشت',callback_data:vM}]);break}q(tK,`openTicket_${tL}_${vM}`,!1);case 'sendNotice':tN=`❓ از ارسال پیام زیر به همه کاربران مطمئن هستید؟

محتویات پیام:
${tL}`;p[tK].fullMessage=tL;tM.push([{text:'✅ تایید و  ارسال',callback_data:'confirmSendNotice'}]);break;case 'getNewConfigTraffic':tL=parseInt(tL);if(isNaN(tL)||tL<0){tN='❌ نوع ورودی صحیح نمی باشد';break}tQ=!1;p[tK].textReciever='getNewConfigDuration';p[tK].newConfigTraffic=tL*1024**3;tN='❔ لطفا مدت زمان مد نظر برای کانفیگ جدید را وارد کنید (به ماه محاسبه میشود): \n\n❕ برای نامحدود 0 را وارد کنید';tM=[[{text:'🔚 بازگشت',callback_data:'userConfigs_'+p[tK].targetUsersId}]];break;case 'getNewConfigDuration':tL=parseInt(tL);if(isNaN(tL)||tL<0){tN='❌ نوع ورودی صحیح نمی باشد';break}tQ=!1;p[tK].textReciever='getNewConfigIP';p[tK].newConfigDuration=tL;tN='❔ لطفا محدودیت کاربر مد نظر برای کانفیگ جدید را وارد کنید: \n\n❕ برای حذف محدودیت 0 را وارد کنید';tM=[[{text:'🔚 بازگشت',callback_data:'userConfigs_'+p[tK].targetUsersId}]];break;case 'getNewConfigIP':tL=parseInt(tL);if(isNaN(tL)||tL<0){tN='❌ نوع ورودی صحیح نمی باشد';break}tQ=!1;p[tK].textReciever='getNewConfigDuration';p[tK].newConfigIP=~~tL;let vN=p[tK].newConfigTraffic;vN=vN==0?'نامحدود':`${vN} GB`;let vO=p[tK].newConfigDuration;vO=vO==0?'نامحدود':`${vO} ماه`;let vP=p[tK].newConfigIP;vP=vP==0?'نامحدود':`${vP} کاربر`;tN=`⁉️ آیا ساخت یک کانفیگ جدید با مشخصات زیر برای کاربر ${p[tK].targetUsersId} مورد تایید شما میباشد؟

🔋 حجم کانفیگ: ${vN}
📅 مدت کانفیگ: ${vO}
👥 محدودیت کاربر: ${vP}`;tM=[[{text:'✅ تایید و افزودن کانفیگ',callback_data:'confirmAddNewConfig'}],[{text:'🔚 بازگشت',callback_data:'userConfigs_'+p[tK].targetUsersId}]];break;case 'getCheckerTimer':tL=parseInt(tL);tM.push([{text:'🔙 بازگشت',callback_data:'management'}]);if(isNaN(tL)||tL<0){tN='❌ نوع ورودی صحیح نمی باشد';break}tL==0?(aO=0,aQ()):(aO=tL*1000,aP());tN='✅ تغییرات با موفقیت ثبت شد';break;default:tP=!1;break}}catch(wJ){d.log(wJ,'WARN');tO=!0}tP&&aE(tK,0,tN,tM,!1);tO&&q(tK,'main_menu',!1,'','','');tQ&&(p[tK].textReciever='')});async function T(wK,wL){let wM;try{let wN=await e.getConfigSubIdBy_uuid(wK,wL);wM=wN.data}catch(wO){d.log(wO,'WARN')}finally{return wM}}async function u(wP,wQ){try{let wR=await c.getAllRows({},'users');wR=wR.data;if(wP=='admins'){let wS=Array();for(let wT of wR)wT.user_lvl>0&&wS.push(wT);wR=[...wS]}for(let wU of wR)aE(wU.userid,0,wQ,[],!1)}catch(wV){d.log(wV)}}async function v(wW,wX,wY){try{let wZ=await c.getFullRow({ticketid:[wX]},'tickets');wZ=wZ.data;wW=wW.replaceAll('%','|درصد|');wZ.messages+=`${wY}%${wW}%%`;wZ.last_response=Date.now();await c.updateFullRow({ticketid:[wX]},{messages:wZ.messages, last_response:wZ.last_response},'tickets');if(wY=='user')w(wW,wX);else{aE(wZ.userid,0,`✔️ کاربر گرامی، به تیکت شماره ${wX} پاسخ داده شد`,[[{text:'📧 مشاهده تیکت',callback_data:'openTicket_'+wX+'_'+'openTickets/1'}]],!1)}}catch(xA){d.log(xA,'WARN')}}async function w(xB,xC){try{let xD=await c.getAllRows({},'users');xD=xD.data;xB=xB.replaceAll('|درصد|','%');let xE=await c.getFullRow({ticketId:[xC]},'tickets');xE=xE.data;let xF=await c.getFullRow({userid:[xE.userid]},'users');xF=xF.data;let xG=xF.userid;let xH=xF.fullname.split('/').join(' ');for(let xI of xD)if(xI.user_lvl>0){aE(xI.userid,0,`💬 پیام جدید از طرف یک کاربر ثبت شد:

⚜️ شماره تیکت: ${xC}
🔰 موضوع تیکت: ${xE.subject}
مشخصات کاربر: ${xG} - ${xH}

پیام:
${xB}`,[[{text:'💬 پاسخ',callback_data:`respondUsersTicket_${xC}`}]],!1)}}catch(xJ){d.log(xJ)}}function x(xK){var xL=['٠','١','٢','٣','٤','٥','٦','٧','٨','٩'],xM=['0','1','2','3','4','5','6','7','8','9'];return xK.replace(/\d/g,xN=>{var xO=xL.indexOf(xN);return xO!==-1?xM[xO]:xN})}async function y(xP){let xQ=await c.getAllRows({location:[xP]},'pricing');let xR={pack:[],addon:[],traffic:[]};for(let xS of xQ.data)switch(xS.type) {case 'pack':xR.pack.push({id:xS.item_id,ipLimit:xS.ip_limit,duration:xS.duration,traffic:xS.traffic,price:xS.price});break;case 'addon':xR.addon={user:xS.ip_limit,month:xS.duration};break;case 'traffic':xR.traffic.push({price:xS.price});let xT=xS.traffic.split(',');xT.pop();for(let xU of xT){let xV=xU.split(':');xR.traffic[xR.traffic.length-1][xV[0]]=xV[1]}break}return xR}async function z(xW,xX,xY){xY=xY?`_${xY}`:'';let xZ=Array();var yA=await y(xW);let yB=`❗️ برای هر ماه زمان اضافه، مبلغ ${yA.addon.month} تومان به هزینه نهایی اضافه میشود
❗️ درصورت نیاز به کاربر/حجم اضافه بعد از خرید میتوانید با مرجعه به (📱 کانفیگ های من>کانفیگ مورد نظر>♻️ تمدید)، کانفیگ خود را ارتقا دهید`;for(let yC of yA.pack){let yD=yC.traffic==0?'حجم نامحدود':yC.traffic+' گیگ';let yE=yC.ipLimit==0?'نامحدود کاربر':yC.ipLimit+' کاربره';let yF=`💠 ${yD} - ${yE} - ${yC.price} تومان`;xZ.push([{text:yF,callback_data:xX+'_'+yC.id+xY}])}return{buttons:xZ,info:yB}}async function aA(yG,yH,yI){let yJ=await y(yG);let yK;for(let yO of yJ.pack)yO.id==yI&&(yK=yO.price);let yL=l.credentials[yG].unlimited_duratoin_price;let yM=yJ.addon.month;let yN=yH==0?(yL-1)*yM+yK:(yH-1)*yM+yK;return yN}async function aB(yP){let yQ=Array();try{let yR=await aC();for(let yS of yR){let yT=await o.telegram.getChatMember(`@${yS}`,yP);yT.user.status=='left'&&yQ.push(yS)}}catch(yU){d.log(yU,'WARN')}finally{return yQ}}async function aC(){let yV=new Set();try{let yW=await c.getAllRows({},'channels');for(let yX of yW.data)yV.add(yX.id)}catch(yY){d.log(yY,'WARN')}finally{return yV}}async function aD(){let yZ=new Set();try{let zA=await c.getAllRows({status:['banned','']},'users');for(let zB of zA.data)yZ.add(zB.userid)}catch(zC){d.log(zC,'WARN')}finally{return yZ}}async function aE(zD,zE,zF,zG,zH){try{zF=zF.replace(/[\#()\+\.\<=-_\{\|\}-]/g,'\\$&');zH===!0?await o.telegram.editMessageText(zD,zE,void 0,zF,{reply_markup:{inline_keyboard:zG},parse_mode:'MarkdownV2'}):await o.telegram.sendMessage(zD,zF,{reply_markup:{inline_keyboard:zG},parse_mode:'MarkdownV2'})}catch(zI){d.log(zI,'ERROR')}}function aF(zJ){return `${zJ}`.replace(/\B(?=(\d{3})+(?!\d))/g,',')}function aG(zK){var zL=['ps','id','add','port'];for(const zN of zL)if(!zK.hasOwnProperty(zN))throw Error(`Missing required property: ${zN}`);const zM=Buffer.from(JSON.stringify({v:'2',ps:zK.ps,add:zK.add,port:zK.port,id:zK.id,scy:'auto',net:'tcp',type:'none',tls:'none'})).toString('base64');return`vmess://${zM}`}function aH(zO){let{ps:zP,add:zQ,port:zR,id:zS}=zO;zP=encodeURIComponent(zP);return`vless://${zS}@${zQ}:${zR}?type=tcp&security=none#${zP}`}function aI(zT){var zU=JSON.parse(atob(zT));if(!zU.id)return;return zU.id}function aJ(zV){if(!zV.includes('@'))return;let zW=zV.slice(0,zV.indexOf('@'));if(zW.length!==36)return;return zW}function aK(){return k()}function aL(zX,zY,zZ){let _temp4='abcdefghijklmnopqrstuvwxyz';zZ===!1&&(_temp4='');zY&&(_temp4+='0123456789');let _temp5=new String();for(i=0;i<zX;i++){_temp5+=_temp4.charAt(~~Math.random()*_temp4.length)}return _temp5}async function aM(_temp,_temp2,_temp3){let _temp6=!0;try{let _temp7=await c.getFullRow({item_id:[_temp]},'pricing');_temp7=_temp7.data;let _temp8=aL(9,!0);let _temp9=aL(16,!0);let _temp10=_temp7.location;let _temp11=A(l.credentials[_temp10].inbounds);let _temp12=Date.now();let _temp13=_temp2==0?0:_temp12+parseInt(_temp2)*30*24*60*60*1000;for(let _temp16 in _temp11){let _temp17=_temp11[_temp16];let _temp18=aK();let _temp19=await e.addClient({id:_temp18, security:'auto', email:_temp8+'-'+_temp16, limitIp:parseInt(_temp7.ip_limit), totalGB:parseInt(_temp7.traffic)*1024**3, expiryTime:_temp13, enable:!0, tgId:'', subId:_temp9, inbound:_temp17},_temp10);if(!_temp19.ok){_temp6=!1;break}}if(!_temp6)return{ok:_temp6,msg:'error in adding client'};let _temp14=await e.getRandomWords(2,4);_temp14=_temp14.data;let _temp15=await c.insertFullRow({owner_id:_temp3,users_id:`${_temp3}/`,subId:_temp9,name:_temp14[0]+'-'+_temp14[1],status:'active',location:_temp10,reserve:'',sentNotice:0},'subscriptions');!_temp15.ok&&(_temp6=!1)}catch(_temp20){_temp6=!1;d.log(_temp20,'ERROR')}finally{return{ok:_temp6}}}let aN;let aO=30000;function aP(){aQ();aN=setInterval(aR,aO)}aP();function aQ(){clearInterval(aN)}async function aR(){try{let _temp21,_temp22,_temp23,_temp24;let _temp25=5*24*60*60*1000;let _temp26=Date.now();let _temp27=A(l.credentials);for(let _temp28 of _temp27){let _temp29=await e.getFinishedClients(_temp28);for(let reason of A(_temp29.data))for(let _temp30 of A(_temp29.data[reason])){let _temp31='';let _temp32=Array();let _temp33=_temp29.data[reason][_temp30];let _temp34=reason=='outdated'?'زمان':'حجم';_temp33+_temp25<=_temp26?_temp23=!0:_temp21=!0;let _temp35=await c.getFullRow({subId:[_temp30]},'subscriptions');_temp35=_temp35.data;if(!_temp35){let _temp36=await e.getConfigInfo(_temp30,_temp28);_temp36=_temp36.data;for(let _temp37 in _temp36.id){let _temp38={};_temp38.id=_temp36.id[_temp37];_temp38.inbound=_temp36.inbound[_temp37];await e.removeClient(_temp38,_temp28)}await e.startClientSync(_temp30,_temp28);d.log(`removed ${_temp30}: ${reason}`,'INFO');continue}if(_temp35.sentNotice==1){_temp21=!1;if(_temp35.reserve){let _temp39=_temp35.reserve.split('/');_temp39.pop();let _temp40=_temp39[_temp39.length-1];let _temp41=await c.getFullRow({reserve_id:[_temp40],subId:[_temp30,'AND'],status:['pending','AND']},'reservations');_temp41.data&&(_temp24=_temp40,_temp34=!1,_temp22=!0)}}if(_temp21){_temp31=`❗️ کانفیگ ${_temp35.name} به دلیل به پایان رسیدن ${_temp34} کانفیگ غیرفعال شد

در صورتی که تمایل به تمدید آن دارید میتوانید با مرجعه به مشخصات کانفیگ آن را تمدید کنید
در غیر اینصورت، کانفیگ به طور خودکار بعد از  5 روز حذف خواهد شدّ`;_temp32.push([{text:'📱 مشاهده کانفیگ',callback_data:`configInfo_${_temp30}`}]);await c.updateFullRow({subId:[_temp30]},{sentNotice:1},'subscriptions');d.log(`${_temp30} was finished, gave a notice`,'INFO')}else if(_temp23){_temp31=`❗️ کانفیگ ${_temp35.name} به دلیل گذشتن از تاریخ مجاز جهت تمدید، حذف شد`;let _temp42=await e.getConfigInfo(_temp30,_temp28);_temp42=_temp42.data;for(let _temp43 in _temp42.id){let _temp44={};_temp44.id=_temp42.id[_temp43];_temp44.inbound=_temp42.inbound[_temp43];await e.removeClient(_temp44,_temp28)}await c.updateFullRow({subId:[_temp30]},{users_id:''},'subscriptions');await e.startClientSync(_temp30,_temp28);d.log(`removed ${_temp30}: ${reason}`,'INFO')}else if(_temp22){let _temp45=await e.getConfigInfo(_temp30,_temp28);_temp45=_temp45.data;let _temp46=await c.getFullRow({reserve_id:[_temp24], subId:[_temp30,'AND']},'reservations');_temp46=_temp46.data;let _temp47=_temp46.duration==0?0:Date.now()+_temp46.duration*30*24*60*60*1000;let _temp48=_temp46.traffic==0?0:_temp46.traffic*1024**3;let _temp49={email:'',enable:!0,expiryTime:_temp47,id:'',limitIp:_temp46.ip,subId:_temp30,tgId:'',totalGB:_temp48,inbound:0};for(let _temp50 in _temp45.id){_temp49.id=_temp45.id[_temp50];_temp49.inbound=_temp45.inbound[_temp50];_temp49.email=_temp45.email[_temp50];await e.updateClient(_temp49,_temp28)}await c.updateFullRow({reserve_id:[_temp24], subId:[_temp30,'AND']},{status:'activated'},'reservations');await c.updateFullRow({subId:[_temp30]},{sentNotice:0},'subscriptions');await e.startClientSync(_temp30,_temp28);_temp31=`✅ کانفیگ ${_temp35.name} به اتمام رسید و کانفیگ رزرو شده به جای آن با موفقیت فعال شد`;_temp32.push([{text:'📱 مشاهده کانفیگ',callback_data:`configInfo_${_temp30}`}]);d.log(`reserve for ${_temp30} was activated`,'INFO')}_temp31!==''&&aE(_temp35.owner_id,0,_temp31,_temp32,!1)}}}catch(_temp51){d.log(_temp51,'ERROR')}}o.launch(_temp52=>{_temp52?d.log('an error has occured while launcging bot: ',_temp52):d.log('the bot is listening','INFO')});
